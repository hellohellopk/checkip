<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Price Checker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Mac Terminal ä¸»é¡Œ */
        body { 
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace; 
            background: #000; 
            color: #00ff00; 
            padding: 20px;
            line-height: 1.6;
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(0, 0, 0, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 255, 0, 0.15);
        }

        /* Terminal æ¨™é¡Œæ¬„ */
        .terminal-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .terminal-dots {
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-red { background: #ff5f56; box-shadow: 0 0 8px #ff5f56; }
        .dot-yellow { background: #ffbd2e; box-shadow: 0 0 8px #ffbd2e; }
        .dot-green { background: #27c93f; box-shadow: 0 0 8px #27c93f; }

        h1 { 
            font-size: 20px; 
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            margin-left: 15px;
        }

        /* åŒ¯ç‡ä¿¡æ¯ - è—è‰² */
        .rate-update { 
            color: #5ac8fa;
            font-size: 11px; 
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* æœç´¢æ¡† */
        input { 
            width: 100%; 
            padding: 12px 15px; 
            background: #1a1a1a; 
            border: 1px solid #00ff00; 
            color: #00ff00; 
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px; 
            border-radius: 6px; 
            margin-bottom: 25px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
        }

        input::placeholder { 
            color: rgba(0, 255, 0, 0.5);
        }

        #searchResults { margin-top: 20px; }

        /* åƒ¹æ ¼ç¶²æ ¼ */
        .price-grid { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin-top: 20px; 
        }

        /* åƒ¹æ ¼è¡Œ - å½©è™¹æ¼¸è®Šé‚Šæ¡† */
        .price-box { 
            background: rgba(0, 0, 0, 0.5); 
            padding: 14px 18px; 
            border-radius: 8px; 
            border: 1px solid transparent;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)),
                linear-gradient(90deg, #ff5f56, #ffbd2e, #27c93f, #5ac8fa, #af52de);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .price-box:hover { 
            transform: translateX(6px);
            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
        }

        .price-box-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        /* åœ°å€æ¨™ç±¤ - ç´…è‰² */
        .country { 
            color: #ff5f56;
            font-weight: 700; 
            font-size: 15px; 
            min-width: 110px;
            text-shadow: 0 0 8px rgba(255, 95, 86, 0.5);
        }

        .price-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* åƒ¹æ ¼ - ç¶ è‰² */
        .price { 
            color: #27c93f;
            font-size: 16px; 
            font-weight: 700;
            text-shadow: 0 0 8px rgba(39, 201, 63, 0.5);
        }

        /* æ¸¯å¹£ - è—è‰² */
        .price-hkd { 
            color: #5ac8fa;
            font-size: 12px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* æŒ‰éˆ• - é»ƒè‰²æ¼¸è®Š */
        .iap-button { 
            background: linear-gradient(135deg, #ffbd2e 0%, #ff9500 100%);
            color: #000; 
            border: none; 
            padding: 9px 18px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 110px;
            box-shadow: 0 0 15px rgba(255, 189, 46, 0.4);
            font-family: 'SF Mono', Monaco, monospace;
        }

        .iap-button:hover { 
            background: linear-gradient(135deg, #ffd60a 0%, #ffbd2e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 189, 46, 0.6);
        }

        .iap-button:disabled { 
            background: #333; 
            color: #666; 
            cursor: not-allowed;
            box-shadow: none;
        }

        /* --- æ›´æ”¹ï¼šApp ä¿¡æ¯å¡ç‰‡ä½ˆå±€ --- */
        .app-info { 
            background: rgba(0, 0, 0, 0.6);
            padding: 25px; 
            border-radius: 10px; 
            border: 1px solid rgba(0, 255, 0, 0.3);
            margin-bottom: 25px;
            display: flex;
            flex-direction: column; /* æ¨™é¡Œåœ¨ä¸Š, å…§å®¹åœ¨ä¸‹ */
            justify-content: flex-start;
            gap: 15px; /* æ¨™é¡Œå’Œå…§å®¹çš„é–“è· */
            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.15);
        }

        /* --- æ–°å¢ï¼šå¡ç‰‡å…§å®¹é«” (è©³ç´°è³‡è¨Š + åœ–ç¤º) --- */
        .app-info-body {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 25px;
            width: 100%;
        }

        .app-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1; /* ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“, å°‡åœ–ç¤ºæ¨åˆ°å³å´ */
        }

        /* App åç¨± - æ©™è‰² */
        .app-name { 
            font-size: 24px; /* --- æ›´æ”¹ï¼šå­—é«”ç¨å¤§ --- */
            font-weight: 700; 
            color: #ff9500;
            text-shadow: 0 0 10px rgba(255, 149, 0, 0.6);
            width: 100%; /* ç¢ºä¿ä½”æ»¿å¯¬åº¦ */
            line-height: 1.3; /* æ”¹å–„é•·æ¨™é¡Œæ›è¡Œ */
        }

        /* é–‹ç™¼è€… - ç´«è‰² */
        .app-dev { 
            color: #af52de;
            font-size: 15px;
            text-shadow: 0 0 8px rgba(175, 82, 222, 0.4);
        }

        /* --- æ›´æ”¹ï¼šSize/Version å·²åœ¨æ­¤è™•ä¸€è¡Œé¡¯ç¤º --- */
        .app-meta {
            display: flex;
            flex-wrap: wrap; /* å…è¨±åœ¨å°è¢å¹•æ›è¡Œ */
            gap: 20px;
            font-size: 12px;
            color: #5ac8fa;
            margin-top: 6px;
        }

        .app-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* App åœ–ç¤º */
        .app-icon {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            flex-shrink: 0;
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(0, 255, 0, 0.2);
            border: 2px solid rgba(0, 255, 0, 0.3);
        }

        /* å…§è³¼å€åŸŸ */
        .iap-container { 
            margin-top: 12px; 
            animation: slideDown 0.3s ease; 
        }

        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .iap-section { 
            background: rgba(0, 0, 0, 0.7);
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid rgba(0, 255, 0, 0.2);
            margin-left: 130px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* æ¨™é¡Œ - ç¶ è‰² */
        .section-title { 
            color: #27c93f;
            font-weight: 700; 
            margin-bottom: 12px; 
            font-size: 13px;
            text-shadow: 0 0 8px rgba(39, 201, 63, 0.5);
        }

        .iap-list { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        /* å…§è³¼é …ç›® - å½©è™¹é‚Šæ¡† */
        .iap-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 12px; 
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px; 
            border-left: 3px solid;
            border-image: linear-gradient(180deg, #ff5f56, #ffbd2e, #27c93f, #5ac8fa, #af52de) 1;
            transition: all 0.3s;
        }

        .iap-item:hover { 
            background: rgba(0, 255, 0, 0.05);
            transform: translateX(4px);
        }

        /* å…§è³¼åç¨± - ç™½è‰²å¸¶ç¶ å…‰ */
        .iap-name { 
            color: #e0e0e0;
            flex: 1; 
            font-size: 12px; 
            line-height: 1.4;
        }

        .iap-price-group { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            margin-left: 12px; 
        }

        /* å…§è³¼åƒ¹æ ¼ - é»ƒè‰² */
        .iap-price { 
            color: #ffbd2e;
            font-weight: 700; 
            font-size: 13px; 
            white-space: nowrap;
            text-shadow: 0 0 8px rgba(255, 189, 46, 0.5);
        }

        /* å…§è³¼æ¸¯å¹£ - è—è‰² */
        .iap-price-hkd { 
            color: #5ac8fa;
            font-size: 10px; 
            margin-top: 3px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* åŠ è¼‰/éŒ¯èª¤ä¿¡æ¯ */
        .iap-loading { 
            padding: 15px; 
            text-align: center; 
            color: #27c93f;
            background: rgba(39, 201, 63, 0.1);
            border-radius: 6px; 
            font-size: 12px;
            text-shadow: 0 0 8px rgba(39, 201, 63, 0.5);
        }

        .iap-none { 
            padding: 15px; 
            text-align: center; 
            color: #666;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px; 
            font-size: 12px;
        }

        .loading-spinner { 
            animation: spin 1s linear infinite; 
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* éŒ¯èª¤ - ç´…è‰² */
        .error-text { 
            color: #ff5f56;
            text-shadow: 0 0 10px rgba(255, 95, 86, 0.6);
        }

        /* åŠ è¼‰ - ç¶ è‰² */
        .loading-text { 
            color: #27c93f;
            text-shadow: 0 0 10px rgba(39, 201, 63, 0.6);
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .price-box { flex-direction: column; align-items: flex-start; }
            .price-box-left { width: 100%; }
            .iap-button { width: 100%; }
            .iap-section { margin-left: 0; }
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 10px;
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff5f56, #ffbd2e, #27c93f, #5ac8fa, #af52de);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
    
        .iap-price-hkd-large {
            color: #27c93f !important;
            font-size: 14px !important;
            font-weight: 700 !important;
            margin-top: 6px !important;
            text-shadow: 0 0 10px rgba(39, 201, 63, 0.5) !important;
            display: block;
        }
        .search-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 25px;
        }
        .search-row input { flex: 1; margin-bottom: 0 !important; }
        .search-go-btn {
            background: linear-gradient(135deg, #ffbd2e 0%, #5ac8fa 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            padding: 12px 16px;
            height: 44px;
            white-space: nowrap;
        }
        .search-go-btn:hover { background: linear-gradient(135deg, #27c93f 0%, #00ff00 100%); }
        .button-row { display: flex; gap: 8px; align-items: center; }
        .refresh-btn {
            background: linear-gradient(135deg, #5ac8fa 0%, #27c93f 100%);
            color: #000;
            border: none;
            padding: 9px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            font-family: 'SF Mono', Monaco, monospace;
            min-width: 90px;
            display: none;
        }
        .refresh-btn:hover { background: linear-gradient(135deg, #27c93f 0%, #00ff00 100%); }
</style>
</head>
<body>
    <div class="container">
        <div class="terminal-header">
            <div class="terminal-dots">
                <div class="dot dot-red"></div>
                <div class="dot dot-yellow"></div>
                <div class="dot dot-green"></div>
            </div>
            <h1>$ app-price-checker</h1>
        </div>

        <div class="rate-update" id="rateUpdate">// Loading exchange rates...</div>
        <div class="search-row"><input type="text" id="searchInput" placeholder="$ search app_name or paste app_store_link"><button class="search-go-btn" id="searchGoBtn">Go</button></div>
        <div id="searchResults"></div>
    </div>

    <script>
        const CORS_PROXIES = [
            'https://go.x2u.in/proxy?email=dollar-zone-strode@duck.com&apiKey=ca297586&url=',
            'https://round-morning-c112.nippon-eb8.workers.dev/?url=',
            'https://test.cors.workers.dev/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://api.allorigins.win/raw?url='
        ];
        let currentProxyIndex = 0;
        const CORS_PROXY = CORS_PROXIES[0];
        const iapCache = new Map();
        let currentApp = null;
        let EXCHANGE_RATES = {};

        function log(msg) { console.log(`[${new Date().toLocaleTimeString()}] ${msg}`); }

        async function loadExchangeRates() {
            try {
                log('ğŸ“Š åŠ è¼‰å¯¦æ™‚åŒ¯ç‡...');
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                const data = await response.json();

                if (data && data.rates) {
                    EXCHANGE_RATES = {
                        'HKD': 1.0,
                        'USD': 1 / data.rates.USD,
                        'JPY': 1 / data.rates.JPY,
                        'TRY': 1 / data.rates.TRY,
                        'INR': 1 / data.rates.INR,
                        'EUR': 1 / data.rates.EUR,
                        'GBP': 1 / data.rates.GBP,
                        'AUD': 1 / data.rates.AUD,
                        'CAD': 1 / data.rates.CAD
                    };

                    log('âœ“ åŒ¯ç‡å·²åŠ è¼‰');
                    const updateTime = new Date(data.time_last_updated * 1000);
                    document.getElementById('rateUpdate').textContent = 
                        `// Exchange rates updated: ${updateTime.toLocaleString('zh-TW')} | USD=${EXCHANGE_RATES.USD.toFixed(2)} | TRY=${EXCHANGE_RATES.TRY.toFixed(4)}`;
                    return true;
                }
            } catch (error) {
                log(`âŒ åŒ¯ç‡åŠ è¼‰å¤±æ•—: ${error.message}`);
                document.getElementById('rateUpdate').textContent = '// Warning: Using default exchange rates';
                EXCHANGE_RATES = { 'HKD': 1.0, 'USD': 7.75, 'JPY': 0.0508, 'TRY': 0.1852, 'INR': 0.088 };
                return false;
            }
        }

        function parsePrice(priceStr) {
            if (!priceStr) return null;
            let cleaned = priceStr.replace(/\s+/g, '');
            const lastComma = cleaned.lastIndexOf(',');
            const lastDot = cleaned.lastIndexOf('.');

            if (lastComma > lastDot && lastComma > 0) {
                const afterComma = cleaned.substring(lastComma + 1);
                if (afterComma.length === 2) {
                    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
                } else {
                    cleaned = cleaned.replace(/,/g, '');
                }
            } else if (lastDot > lastComma && lastDot > 0) {
                cleaned = cleaned.replace(/,/g, '');
            }

            const match = cleaned.match(/([\d.]+)/);
            return match ? parseFloat(match[1]) : null;
        }

        function convertToHKD(priceStr, currencyCode) {
            if (!priceStr) return null;
            const amount = parsePrice(priceStr);
            if (!amount || amount === 0 || isNaN(amount)) return null;

            let currency = currencyCode; 

            if (!currency) {
                if (priceStr.includes('$') && !priceStr.includes('HK$')) currency = 'USD';
                else if (priceStr.includes('HK$')) currency = 'HKD';
                else if (priceStr.includes('Â¥') || priceStr.includes('JPY')) currency = 'JPY';
                else if (priceStr.includes('â‚º') || priceStr.includes('TRY')) currency = 'TRY';
                else if (priceStr.includes('â‚¹') || priceStr.includes('INR')) currency = 'INR';
                else if (priceStr.includes('â‚¬') || priceStr.includes('EUR')) currency = 'EUR';
                else if (priceStr.includes('Â£') || priceStr.includes('GBP')) currency = 'GBP';
                else currency = 'USD'; 
            }

            const rate = EXCHANGE_RATES[currency] || 1;
            const hkdAmount = amount * rate;
            return { original: priceStr, hkd: `â‰ˆ HK$ ${hkdAmount.toFixed(2)}`, amount: hkdAmount, currency: currency };
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        loadExchangeRates();

        document.getElementById('searchInput').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    if (Object.keys(EXCHANGE_RATES).length === 0) await loadExchangeRates();

                    if (query.startsWith('https://apps.apple.com')) {
                        const match = query.match(/\/id(\d+)/); 
                        if (match && match[1]) {
                            const appId = match[1];
                            await searchAppById(appId); 
                        } else {
                            document.getElementById('searchResults').innerHTML = '<div class="error-text">// Error: Invalid App Store URL</div>';
                        }
                    } else {
                        await searchApp(query); 
                    }
                }
            }
        });

        async function searchApp(query) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading-text">// Searching...</div>';

            try {
                const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&country=us&entity=software&limit=1`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    currentApp = data.results[0];
                    await displayApp(currentApp);
                } else {
                    resultsDiv.innerHTML = '<div class="error-text">// Error: App not found</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error-text">// Error: Search failed</div>';
            }
        }

        async function searchAppById(appId) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading-text">// Looking up App ID...</div>';

            try {
                const response = await fetch(`https://itunes.apple.com/lookup?id=${appId}&country=us&entity=software`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    currentApp = data.results[0];
                    await displayApp(currentApp); 
                } else {
                    resultsDiv.innerHTML = '<div class="error-text">// Error: App ID not found</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error-text">// Error: Lookup failed</div>';
            }
        }


        // --- æ›´æ”¹ï¼šæ›´æ–° HTML çµæ§‹ ---
        async function displayApp(app) {
            const countries = [
                { name: 'ğŸ‡ºğŸ‡¸ US', code: 'us', currency: 'USD' },
                { name: 'ğŸ‡­ğŸ‡° HK', code: 'hk', currency: 'HKD' },
                { name: 'ğŸ‡¯ğŸ‡µ JP', code: 'jp', currency: 'JPY' },
                { name: 'ğŸ‡¹ğŸ‡· TR', code: 'tr', currency: 'TRY' },
                { name: 'ğŸ‡®ğŸ‡³ IN', code: 'in', currency: 'INR' }
            ];

            // 1. å»ºç«‹ App è³‡è¨Šå¡ç‰‡
            let html = '<div class="app-info">';
            
            // æ¨™é¡Œ (ä½”æ»¿é ‚éƒ¨)
            html += '<div class="app-name">' + app.trackName + '</div>';

            // å…§å®¹æ˜“å™¨ (è©³ç´°è³‡è¨Š + åœ–ç¤º)
            html += '<div class="app-info-body">';
            
            // å·¦å´è©³ç´°è³‡è¨Š
            html += '<div class="app-details">';
            html += '<div class="app-dev">// ' + app.artistName + '</div>';
            
            // Size/Version (å·²åœ¨åŒä¸€è¡Œ)
            html += '<div class="app-meta">';
            if (app.fileSizeBytes) {
                html += '<div class="app-meta-item">ğŸ“¦ ' + formatFileSize(parseInt(app.fileSizeBytes)) + '</div>';
            }
            if (app.version) {
                html += '<div class="app-meta-item">ğŸ”– v' + app.version + '</div>';
            }
            html += '</div>'; // çµæŸ .app-meta
            html += '</div>'; // çµæŸ .app-details

            // å³å´åœ–ç¤º
            if (app.artworkUrl100 || app.artworkUrl512) {
                const iconUrl = (app.artworkUrl512 || app.artworkUrl100).replace('100x100', '512x512');
                html += '<img src="' + iconUrl + '" class="app-icon" alt="' + app.trackName + '">';
            }
            
            html += '</div>'; // çµæŸ .app-info-body
            html += '</div>'; // çµæŸ .app-info

            // 2. å»ºç«‹åƒ¹æ ¼ç¶²æ ¼ (èˆ‡ä¹‹å‰ç›¸åŒ)
            html += '<div class="price-grid">';

            const promises = countries.map(country =>
                fetch(`https://itunes.apple.com/lookup?id=${app.trackId}&country=${country.code}`)
                    .then(res => res.json())
                    .then(data => ({ data, country })) 
            );

            const results = await Promise.allSettled(promises);
            let priceHtml = '';

            for (const [index, result] of results.entries()) {
                const country = countries[index]; 

                if (result.status === 'fulfilled') {
                    const { data } = result.value;
                    if (data.results && data.results.length > 0) {
                        const appData = data.results[0];
                        const priceNum = appData.price;
                        const currency = appData.currency;

                        let priceDisplay, hkdDisplay = '';

                        if (priceNum === 0) {
                            priceDisplay = 'FREE';
                        } else {
                            priceDisplay = currency + ' ' + priceNum;
                            const converted = convertToHKD(priceNum.toString(), currency);
                            if (converted && currency !== 'HKD') {
                                hkdDisplay = '<div class="price-hkd">' + converted.hkd + '</div>';
                            }
                        }
                        
                        priceHtml += '<div class="price-box">';
                        priceHtml += '<div class="price-box-left">';
                        priceHtml += '<div class="country">' + country.name + '</div>';
                        priceHtml += '<div class="price-info"><div class="price">' + priceDisplay + '</div>' + hkdDisplay + '</div>';
                        priceHtml += '</div>';
                        priceHtml += '<div class="button-row"><button class="refresh-btn" style="display:none">ğŸ”„ Refresh</button><button class="iap-button" onclick="loadIAP(this, \'' + country.code + '\', \'' + app.trackId + '\', \'' + country.name + '\', \'' + country.currency + '\')">VIEW IAP</button></div>';
                        priceHtml += '</div>';
                    } else {
                        priceHtml += '<div class="price-box"><div class="price-box-left"><div class="country">' + country.name + '</div><div class="price-info"><div class="price" style="color: #666;">N/A</div></div></div></div>';
                    }
                } else {
                    log(`âŒ ${country.name} åƒ¹æ ¼ç²å–å¤±æ•—: ${result.reason}`);
                    priceHtml += '<div class="price-box"><div class="price-box-left"><div class="country">' + country.name + '</div><div class="price-info"><div class="price" style="color: #666;">ERROR</div></div></div></div>';
                }
            }

            html += priceHtml; 
            html += '</div>'; 
            document.getElementById('searchResults').innerHTML = html;
        
            setTimeout(async function() {
                log('ğŸ¤– è‡ªå‹•ç²å–å…§è³¼è³‡è¨Š...');
                const buttons = document.querySelectorAll('.iap-button');
                for (let i = 0; i < buttons.length; i++) {
                    log(`è‡ªå‹•åŠ è¼‰ ${i + 1}/${buttons.length}...`);
                    try {
                        buttons[i].click();
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (e) {}
                }
                log('âœ… è‡ªå‹•åŠ è¼‰å®Œæˆ');
            }, 800);
}

        async function loadIAP(button, countryCode, appId, countryName, currency) {
            log(`=== ${countryName} IAP ===`);
            button.disabled = true;
            button.innerHTML = 'LOADING...';

            const priceBox = button.closest('.price-box');
            let container = priceBox.nextElementSibling;

            if (!container || !container.classList.contains('iap-container')) {
                container = document.createElement('div');
                container.className = 'iap-container';
                priceBox.parentElement.insertBefore(container, priceBox.nextSibling);
            }

            container.innerHTML = '<div class="iap-loading"><span class="loading-spinner">â³</span> Fetching IAP data...</div>';

            try {
                const iapData = await getIAPByRegion(appId, countryCode, currency);

                if (!iapData || iapData.length === 0) {
                    container.innerHTML = '<div class="iap-none">// No in-app purchases</div>';
                    button.innerHTML = 'CHECKED âœ“';
                } else {
                    let html = '<div class="iap-section"><div class="section-title">// ' + countryName + ' In-App Purchases (' + iapData.length + ')</div><div class="iap-list">';
                    iapData.forEach(item => {
                        html += '<div class="iap-item"><span class="iap-name">' + item.title + '</span><div class="iap-price-group"><span class="iap-price">' + item.price + '</span>';
                        if (item.hkd) html += '<span class="iap-price-hkd-large">' + item.hkd + '</span>';
                        html += '</div></div>';
                    });
                    html += '</div></div>';
                    container.innerHTML = html;
                    button.innerHTML = 'LOADED (' + iapData.length + ')';
                }
            } catch (e) {
                log(`âŒ ${e.message}`);
                container.innerHTML = '<div class="iap-none">// Error: Failed to fetch</div>';
                button.innerHTML = 'RETRY';
                button.disabled = false;
            }
        }

        async function getIAPByRegion(appId, countryCode, currency) {
            const cacheKey = `${appId}_${countryCode}`;
            if (iapCache.has(cacheKey)) { log('âœ“ Cache'); return iapCache.get(cacheKey); }

            let html = ''; // è®“ html åœ¨ try-catch å¤–éƒ¨å¯è¦‹

            try {
                let url = currentApp && currentApp.trackViewUrl ? 
                    currentApp.trackViewUrl.replace(/\/[a-z]{2}\//, `/${countryCode}/`) : 
                    `https://apps.apple.com/${countryCode}/app/id${appId}`;

                log(`URL: ${url}`);

                // Try multiple CORS proxies if needed
                let response;
                let lastError;
                for (let i = 0; i < CORS_PROXIES.length; i++) {
                    try {
                        const proxyUrl = CORS_PROXIES[i] + encodeURIComponent(url);
                        log(`  å˜—è©¦ Proxy ${i+1}/${CORS_PROXIES.length}: ${CORS_PROXIES[i].substring(0, 30)}...`);
                        response = await fetch(proxyUrl, { 
                            method: 'GET',
                            headers: { 'Accept': 'text/html,application/xhtml+xml' }
                        });
                        if (response.ok) {
                            log(`  âœ“ Proxy ${i+1} æˆåŠŸ (${response.status})`);
                            currentProxyIndex = i;
                            break;
                        } else {
                            log(`  âœ— Proxy ${i+1} HTTP ${response.status}`);
                        }
                    } catch (err) {
                        lastError = err;
                        log(`  âœ— Proxy ${i+1} å¤±æ•—: ${err.message}`);
                    }
                }
                if (!response || !response.ok) {
                    throw lastError || new Error(`æ‰€æœ‰ ${CORS_PROXIES.length} å€‹ CORS proxy éƒ½å¤±æ•—`);
                }

                html = await response.text(); // å°‡ html è³¦å€¼
                log(`âœ“ ${html.length} chars`);
                
                const match = html.match(/<script id="shoebox-ember-data-store" type="application\/json">([\s\S]*?)<\/script>/);
                if (!match || !match[1]) {
                    log('! æœªæ‰¾åˆ° shoebox dataã€‚é é¢çµæ§‹å¯èƒ½å·²æ›´æ”¹ã€‚');
                    // *** è­¦å‘Š: Fallback åˆ° HTML çˆ¬èŸ² ***
                    log('! Fallback to HTML scraping...');
                    return await getIAPByRegion_Scraping(html, currency); 
                }

                const shoebox = JSON.parse(match[1]);
                const purchases = [];
                
                if (!shoebox.included && !shoebox.data) {
                    log('! Shoebox data ä¸­æ²’æœ‰ "included" æˆ– "data" é™£åˆ—ã€‚');
                    return [];
                }
                
                const allData = [
                    ...(Array.isArray(shoebox.data) ? shoebox.data : [shoebox.data]), 
                    ...(shoebox.included || [])
                ].filter(Boolean);


                // 1. å»ºç«‹ Price Map (ID -> åƒ¹æ ¼å°è±¡)
                const priceMap = new Map();
                allData.forEach(item => {
                    if (item.type === 'in-app-purchase-price') {
                        priceMap.set(item.id, item.attributes);
                    }
                });

                // 2. å»ºç«‹ IAP Map (ID -> IAP å°è±¡)
                const iapMap = new Map();
                allData.forEach(item => {
                    if (item.type === 'in-app-purchase' || item.type === 'subscription') {
                        iapMap.set(item.id, item);
                    }
                });
                
                log(`  âœ“ æ‰¾åˆ° ${iapMap.size} å€‹ IAP/Subscription é …ç›®ã€‚`);

                // 3. [æ–°ç­–ç•¥] ç›´æ¥éæ­· iapMap, ä¸å†ä¾è³´ 'relationships'
                for (const iapItem of iapMap.values()) {
                    try {
                        const name = iapItem.attributes.name;
                        
                        if (iapItem.type === 'in-app-purchase') {
                             if (!iapItem.relationships || !iapItem.relationships.price || !iapItem.relationships.price.data) {
                                log(`  ! IAP ${name} æ²’æœ‰åƒ¹æ ¼é—œè¯ã€‚`);
                                continue;
                            }
                            const priceId = iapItem.relationships.price.data.id;
                            const priceData = priceMap.get(priceId);

                            if (name && priceData) {
                                const priceText = priceData.priceFormatted;
                                const converted = convertToHKD(priceText, currency);
                                purchases.push({ title: name, price: priceText, hkd: converted ? converted.hkd : null });
                                log(`  âœ“ [IAP] ${name} - ${priceText}`);
                            }
                        } 
                        else if (iapItem.type === 'subscription') {
                            log(`  ! æ‰¾åˆ°è¨‚é–± ${name}, ä½†é‚è¼¯å°šæœªå¯¦ç¾ã€‚`);
                        }

                    } catch (e) {
                        log(`  ! è§£æ IAP é …ç›®å¤±æ•—: ${e.message}`);
                    }
                }

                // 4. å¦‚æœ JSON æ‰¾ä¸åˆ°, å†æ¬¡å˜—è©¦ HTML çˆ¬èŸ² (ä½œç‚ºæœ€å¾Œæ‰‹æ®µ)
                if (purchases.length === 0 && html) { // ç¢ºä¿ html å·²è¢«åŠ è¼‰
                    log("! JSON è§£ææœªæ‰¾åˆ° IAPã€‚ å˜—è©¦ HTML çˆ¬èŸ²...");
                    return await getIAPByRegion_Scraping(html, currency);
                }
                
                if (purchases.length > 0) {
                    iapCache.set(cacheKey, purchases);
                    setTimeout(() => iapCache.delete(cacheKey), 24 * 60 * 60 * 1000);
                }

                log(`âœ“ ${countryCode.toUpperCase()}: ${purchases.length}`);
                return purchases;

            } catch (e) {
                log(`âŒ çˆ¬å– IAP å¤±æ•—: ${e.message}`);
                 // å¦‚æœ fetch æˆ– JSON parse å¤±æ•—, å˜—è©¦ä½¿ç”¨ html (å¦‚æœå·²æŠ“å–)
                if (html) {
                    log("! ç™¼ç”ŸéŒ¯èª¤, å˜—è©¦ HTML çˆ¬èŸ²ä½œç‚ºæœ€çµ‚æ‰‹æ®µ...");
                    return await getIAPByRegion_Scraping(html, currency);
                }
                return null;
            }
        }
        
        async function getIAPByRegion_Scraping(html, currency) {
            log("  [Scraping] åŸ·è¡Œ HTML çˆ¬èŸ²...");
            const purchases = [];
            const seen = new Set();
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const priceEls = doc.querySelectorAll('.list-with-numbers__item__price, .product-header__list__item__price, .app-offer__price, [class*="purchase"] [class*="price"]');
                log(`  [Scraping] æ‰¾åˆ° ${priceEls.length} å€‹åƒ¹æ ¼å…ƒç´ `);

                if (priceEls.length > 0) {
                    priceEls.forEach((priceEl, i) => {
                        const priceText = priceEl.textContent.trim();
                        if (!priceText || priceText.toLowerCase() === 'free' || priceText.toLowerCase() === 'get') return;

                        const parent = priceEl.closest('.list-with-numbers__item, .product-header__list__item, li, .app-offer, [class*="purchase-item"]');
                        if (parent) {
                            let name = null;
                            const nameEl = parent.querySelector('.list-with-numbers__item__title, .product-header__list__item__name, h3, h4, strong, [class*="title"], [class*="name"]');
                            if (nameEl) name = nameEl.textContent.trim();

                            if (!name) {
                                const allText = parent.textContent.replace(priceText, '').trim();
                                const lines = allText.split('\n').map(l => l.trim()).filter(l => l && l.length > 2 && l.length < 100);
                                name = lines[0] || null;
                            }
                            
                            if (name && name.toLowerCase().includes('in-app purchase')) {
                                name = null;
                            }

                            if (name && name.length >= 2 && name.length < 100) {
                                const key = name + '|' + priceText;
                                if (!seen.has(key)) {
                                    const converted = convertToHKD(priceText, currency);
                                    purchases.push({ title: name, price: priceText, hkd: converted ? converted.hkd : null });
                                    seen.add(key);
                                    log(`  [Scraping] ${i+1}. ${name} - ${priceText}`);
                                }
                            } else {
                                log(`  [Scraping] ${i+1}. æ‰¾åˆ°åƒ¹æ ¼ ${priceText} ä½†æœªæ‰¾åˆ°åç¨±ã€‚`);
                            }
                        }
                    });
                }
                return purchases;
            } catch (e) {
                 log(`  [Scraping] çˆ¬èŸ²å¤±æ•—: ${e.message}`);
                 return null; // çˆ¬èŸ²å¤±æ•—
            }
        }

    

        // ========== å€åŸŸå°ˆç”¨ CORS ä»£ç†é…ç½® ==========
        // US=1, HK=2, JP=3, TR=4, IN=5
        const CORS_PROXIES_BY_REGION = {
            'us': 'https://go.x2u.in/proxy?email=dollar-zone-strode@duck.com&apiKey=ca297586&url=',
            'hk': 'https://round-morning-c112.nippon-eb8.workers.dev/?url=',
            'jp': 'https://test.cors.workers.dev/?',
            'tr': 'https://api.codetabs.com/v1/proxy?quest=',
            'in': 'https://api.allorigins.win/raw?url='
        };

        const CORS_PROXIES_FALLBACK = [
            'https://go.x2u.in/proxy?email=dollar-zone-strode@duck.com&apiKey=ca297586&url=',
            'https://round-morning-c112.nippon-eb8.workers.dev/?url=',
            'https://test.cors.workers.dev/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];

        async function fetchWithRegionProxy(url, countryCode, maxRetries = 6) {
            let lastError = null;

            // 1. å„ªå…ˆä½¿ç”¨å€åŸŸå°ˆç”¨ä»£ç†
            const primaryProxy = CORS_PROXIES_BY_REGION[countryCode.toLowerCase()];
            if (primaryProxy) {
                try {
                    log(`  [ä¸»ä»£ç†] ${countryCode.toUpperCase()} ä½¿ç”¨å°ˆç”¨ä»£ç†...`);
                    const proxyUrl = primaryProxy + encodeURIComponent(url);
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'text/html,application/xhtml+xml' }
                    });

                    if (response.ok) {
                        log(`  âœ“ ${countryCode.toUpperCase()} å°ˆç”¨ä»£ç†æˆåŠŸ`);
                        return await response.text();
                    } else {
                        log(`  âœ— å°ˆç”¨ä»£ç† HTTP ${response.status}`);
                        lastError = new Error(`HTTP ${response.status}`);
                    }
                } catch (err) {
                    log(`  âœ— å°ˆç”¨ä»£ç†å¤±æ•—: ${err.message}`);
                    lastError = err;
                }
            }

            // 2. å°ˆç”¨ä»£ç†å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨ä»£ç†ï¼ˆæœ€å¤š 6 æ¬¡ï¼‰
            log(`  é–‹å§‹å‚™ç”¨ä»£ç†å˜—è©¦...`);
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                const proxyIndex = attempt % CORS_PROXIES_FALLBACK.length;
                const proxy = CORS_PROXIES_FALLBACK[proxyIndex];
                const proxyUrl = proxy + encodeURIComponent(url);

                try {
                    log(`  [CORS ${attempt + 1}/${maxRetries}] å˜—è©¦å‚™ç”¨ä»£ç† ${proxyIndex + 1}...`);
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'text/html,application/xhtml+xml' }
                    });

                    if (response.ok) {
                        log(`  âœ“ å‚™ç”¨ä»£ç† ${proxyIndex + 1} æˆåŠŸ`);
                        return await response.text();
                    } else {
                        log(`  âœ— å‚™ç”¨ä»£ç† ${proxyIndex + 1} HTTP ${response.status}`);
                        lastError = new Error(`HTTP ${response.status}`);
                    }
                } catch (err) {
                    log(`  âœ— å‚™ç”¨ä»£ç† ${proxyIndex + 1} å¤±æ•—: ${err.message}`);
                    lastError = err;
                }

                if (attempt < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }

            throw lastError || new Error(`æ‰€æœ‰ä»£ç†å‡å¤±æ•—ï¼ˆå·²å˜—è©¦ ${maxRetries} æ¬¡ï¼‰`);
        }

        // Go æŒ‰éˆ•äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const goBtn = document.getElementById('searchGoBtn');
            if (goBtn) {
                goBtn.addEventListener('click', async function() {
                    const input = document.getElementById('searchInput');
                    const query = input.value.trim();
                    if (query) {
                        if (Object.keys(EXCHANGE_RATES).length === 0) await loadExchangeRates();
                        if (query.startsWith('https://apps.apple.com')) {
                            const match = query.match(/\/id(\d+)/);
                            if (match && match[1]) await searchAppById(match[1]);
                        } else {
                            await searchApp(query);
                        }
                    }
                });
                document.getElementById('searchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') goBtn.click();
                });
            }
        });
</script>
</body>
</html>
