<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro - Notion Style</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --notion-bg: #FFFFFF;
            --notion-card: #F7F7F5;
            --notion-text: #37352F;
            --notion-subtext: #787774;
            --notion-border: #EDECE9;
            --primary-green: #22C55E;
            --accent-blue: #3B82F6;
            --warn-yellow: #DFAB01;
            --error-red: #EB5757;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--notion-bg);
            color: var(--notion-text);
            padding: 0;
            overflow-x: hidden;
        }

        /* 頂部導航 */
        .header {
            background: var(--notion-bg);
            padding: 24px 20px 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .icon-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon-btn {
            background: white;
            border: 1px solid var(--notion-border);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            color: var(--notion-subtext);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:active { background: #F1F1EF; transform: scale(0.95); }
        .icon-btn.active { background: #FDECEC; color: var(--error-red); border-color: #F8D7D7; }

        /* API 選擇器容器 */
        .api-box {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--notion-card);
            border: 1px solid var(--notion-border);
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .api-select {
            background: transparent;
            border: none;
            font-size: 11px;
            color: var(--accent-blue);
            font-weight: 700;
            outline: none;
            cursor: pointer;
            font-family: inherit;
        }

        .status-bar {
            font-size: 11px;
            color: var(--notion-subtext);
            margin-top: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        /* 列表佈局 */
        .currency-list {
            width: 100%;
            padding: 0 16px;
        }

        .currency-card {
            background: var(--notion-card);
            display: flex;
            align-items: center;
            padding: 18px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            position: relative;
            width: 100%;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .currency-card:active { background: #F1F1EF; transform: scale(0.99); }

        .flag-box {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 14px;
            border: 1px solid var(--notion-border);
            flex-shrink: 0;
            background: white;
        }
        .flag-box img { width: 100%; height: 100%; object-fit: cover; }

        .info { flex: 1; min-width: 0; }
        .code { font-size: 17px; font-weight: 700; color: var(--notion-text); }
        .name { font-size: 12px; color: var(--notion-text); opacity: 0.6; margin-top: 2px; line-height: 1.3; }

        .values { text-align: right; }
        .amount { 
            font-size: 21px; 
            font-weight: 700; 
            color: var(--notion-text); 
            letter-spacing: -0.5px;
        }
        .symbol { color: var(--primary-green); font-size: 14px; margin-right: 3px; font-weight: 700; }
        .rate-info { font-size: 11px; color: var(--accent-blue); margin-top: 4px; font-weight: 600; text-transform: uppercase; }

        /* 列表底部按鈕 */
        .footer-actions {
            padding: 8px 16px 40px 16px;
        }
        .add-row-btn {
            background: white;
            border: 1px solid var(--notion-border);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--notion-subtext);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* 編輯模式 */
        .del-btn {
            position: absolute;
            left: -8px;
            top: -8px;
            background: var(--error-red);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;
            border: 2px solid white;
            font-weight: bold;
            z-index: 10;
        }
        .editing .del-btn { display: flex; align-items: center; justify-content: center; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.25);
            z-index: 1000;
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .calc-modal-content {
            background: white;
            width: 90%;
            max-width: 360px;
            border-radius: 28px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid var(--notion-border);
        }
        .calc-display {
            background: var(--notion-card);
            padding: 24px 20px;
            border-radius: 20px;
            text-align: right;
            margin-bottom: 24px;
            border: 1px solid var(--notion-border);
        }
        .calc-val { font-size: 34px; font-weight: 700; color: var(--notion-text); }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .g-btn {
            background: white;
            border: 1px solid var(--notion-border);
            color: var(--notion-text);
            padding: 18px 0;
            font-size: 20px;
            font-weight: 600;
            border-radius: 16px;
            cursor: pointer;
        }
        .g-btn:active { background: var(--notion-card); transform: scale(0.95); }
        .g-btn.op { color: var(--accent-blue); background: #F0F7FF; }
        .g-btn.done { background: var(--primary-green); color: white; grid-column: span 2; border: none; }

        /* 新增貨幣全屏選擇 */
        .full-modal-content {
            background: white;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--notion-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #currency-options { flex: 1; overflow-y: auto; }
        .opt-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--notion-border);
            cursor: pointer;
        }
        .opt-item:active { background: var(--notion-card); }
    </style>
</head>
<body>

    <header class="header">
        <div class="toolbar">
            <h1 style="font-size: 26px; font-weight: 800; letter-spacing: -1.2px;">Finance</h1>
            <div class="icon-group">
                <div class="api-box">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
                    <select class="api-select" id="api-selector">
                        <option value="exchangeratefree">ExchangeRate (Free)</option>
                        <option value="fxratesapi">FXRatesAPI</option>
                        <option value="exchangerate">ExchangeRate (V6)</option>
                        <option value="openexchange">Open Exchange</option>
                    </select>
                </div>
                <button class="icon-btn" id="edit-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="icon-btn" id="header-add-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
        </div>
        <div class="status-bar">
            <span style="color:var(--primary-green); font-size: 8px;">●</span>
            <span id="sync-status">市場數據同步中...</span>
        </div>
    </header>

    <main id="list-container">
        <div id="list" class="currency-list"></div>
        <div class="footer-actions">
            <div class="add-row-btn" id="footer-add-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>新增</span>
            </div>
        </div>
    </main>

    <!-- 計算機 Modal -->
    <div class="modal" id="calc-modal">
        <div class="calc-modal-content">
            <div id="calc-target" style="font-size:12px; color:var(--notion-subtext); margin-bottom:12px; font-weight:700;">// 計算目標: HKD</div>
            <div class="calc-display">
                <div id="calc-expr" style="color:var(--notion-subtext); font-size:12px; min-height:1.2em; margin-bottom: 4px;"></div>
                <div id="calc-screen" class="calc-val">0</div>
            </div>
            <div class="calc-grid" id="calc-keys"></div>
        </div>
    </div>

    <!-- 新增貨幣 Modal -->
    <div class="modal" id="add-modal">
        <div class="full-modal-content">
            <div class="modal-header">
                <span style="font-weight: 800; font-size: 18px;">選擇貨幣</span>
                <button class="icon-btn" onclick="closeModal('add-modal')" style="border:none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="currency-options"></div>
        </div>
    </div>

    <script>
        // API 配置
        const API_CONFIGS = {
            fxratesapi: { name: 'FXRatesAPI', key: 'fxr_live_38ad3c55b228cc844e71347bdb45cb3c63df', buildUrl: (key) => `https://api.fxratesapi.com/latest?api_key=${key}&base=USD`, parseResponse: (d) => ({ success: d.success, rates: d.rates, ts: d.timestamp }) },
            exchangeratefree: { name: 'ExchangeRate (Free)', key: '', buildUrl: () => `https://api.exchangerate-api.com/v4/latest/USD`, parseResponse: (d) => ({ success: true, rates: d.rates, ts: d.time_last_updated }) },
            exchangerate: { name: 'ExchangeRate (V6)', key: '0d5edd3dbe453790b0bcc4d6', buildUrl: (k) => `https://v6.exchangerate-api.com/v6/${k}/latest/USD`, parseResponse: (d) => ({ success: d.result==='success', rates: d.conversion_rates, ts: d.time_last_update_unix }) },
            openexchange: { name: 'Open Exchange', key: '219fb31cd84b49acb19edb3cb5e7cdfd', buildUrl: (k) => `https://openexchangerates.org/api/latest.json?app_id=${k}`, parseResponse: (d) => ({ success: true, rates: d.rates, ts: d.timestamp }) }
        };

        // 貨幣清單
        const currencyData = {
            USD: { n: 'United States Dollar', c: 'us', s: '$' }, EUR: { n: 'Euro', c: 'eu', s: '€' },
            JPY: { n: 'Japanese Yen', c: 'jp', s: '¥' }, GBP: { n: 'British Pound Sterling', c: 'gb', s: '£' },
            CNY: { n: 'Chinese Yuan', c: 'cn', s: '¥' }, HKD: { n: 'Hong Kong Dollar', c: 'hk', s: 'HK$' },
            TWD: { n: 'New Taiwan Dollar', c: 'tw', s: 'NT$' }, KRW: { n: 'South Korean Won', c: 'kr', s: '₩' },
            TRY: { n: 'Turkish Lira', c: 'tr', s: '₺' }, INR: { n: 'Indian Rupee', c: 'in', s: '₹' },
            AUD: { n: 'Australian Dollar', c: 'au', s: 'A$' }, CAD: { n: 'Canadian Dollar', c: 'ca', s: 'C$' },
            CHF: { n: 'Swiss Franc', c: 'ch', s: 'CHF' }, SGD: { n: 'Singapore Dollar', c: 'sg', s: 'S$' },
            NZD: { n: 'New Zealand Dollar', c: 'nz', s: 'NZ$' }, THB: { n: 'Thai Baht', c: 'th', s: '฿' },
            MYR: { n: 'Malaysian Ringgit', c: 'my', s: 'RM' }, PHP: { n: 'Philippine Peso', c: 'ph', s: '₱' },
            VND: { n: 'Vietnamese Dong', c: 'vn', s: '₫' }, MOP: { n: 'Macao Pataca', c: 'mo', s: 'MOP$' }
        };

        let activeList = JSON.parse(localStorage.getItem('fx_notion_v13')) || ['HKD', 'USD', 'CNY', 'TWD', 'JPY', 'GBP', 'KRW', 'TRY', 'INR'];
        let rates = null;
        let baseHKD = 1000;
        let isEditing = false;
        let currentInput = "0";
        let targetCode = "HKD";

        async function sync() {
            const apiId = document.getElementById('api-selector').value;
            const config = API_CONFIGS[apiId];
            try {
                const res = await fetch(config.buildUrl(config.key));
                const data = await res.json();
                const parsed = config.parseResponse(data);
                
                // 轉換為以 HKD 為基準的匯率
                const hkdPerUsd = parsed.rates['HKD'];
                rates = {};
                for(let k in parsed.rates) rates[k] = parsed.rates[k] / hkdPerUsd;
                rates['HKD'] = 1;

                document.getElementById('sync-status').textContent = `最後同步於: ${new Date().toLocaleTimeString()}`;
                render();
            } catch (e) { document.getElementById('sync-status').textContent = "同步失敗"; }
        }

        function render() {
            const container = document.getElementById('list');
            container.innerHTML = '';
            activeList.forEach(code => {
                const meta = currencyData[code] || { n: code, c: 'un', s: '' };
                const rate = rates[code] || 0;
                const val = baseHKD * rate;
                const card = document.createElement('div');
                card.className = `currency-card ${isEditing ? 'editing' : ''}`;
                card.onclick = () => !isEditing && openCalc(code, val);
                card.innerHTML = `
                    <button class="del-btn" onclick="event.stopPropagation(); removeCode('${code}')">✕</button>
                    <div class="flag-box"><img src="https://flagcdn.com/w160/${meta.c}.png" onerror="this.src='https://via.placeholder.com/42'"></div>
                    <div class="info">
                        <div class="code">${code}</div>
                        <div class="name">${meta.n}</div>
                    </div>
                    <div class="values">
                        <div class="amount"><span class="symbol">${meta.s}</span>${val.toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                        <div class="rate-info">${code === 'HKD' ? 'Base Asset' : `1 HKD = ${rate.toFixed(4)} ${code}`}</div>
                    </div>
                `;
                container.appendChild(card);
            });
            localStorage.setItem('fx_notion_v13', JSON.stringify(activeList));
        }

        function openCalc(code, val) {
            targetCode = code;
            currentInput = val.toFixed(2);
            document.getElementById('calc-target').textContent = `// 目標貨幣: ${code}`;
            document.getElementById('calc-screen').textContent = currentInput;
            document.getElementById('calc-modal').classList.add('active');
            buildKeys();
        }

        function buildKeys() {
            const keys = ['AC', 'DEL', '÷', '×', '7', '8', '9', '-', '4', '5', '6', '+', '1', '2', '3', '.', '0', '00', 'DONE'];
            const container = document.getElementById('calc-keys');
            container.innerHTML = '';
            keys.forEach(k => {
                const b = document.createElement('button');
                b.className = `g-btn ${['÷','×','-','+'].includes(k) ? 'op' : ''} ${k === 'DONE' ? 'done' : ''}`;
                b.textContent = k === 'DONE' ? '確認換算' : k;
                b.onclick = () => handleKey(k);
                container.appendChild(b);
            });
        }

        function handleKey(k) {
            if (k === 'AC') currentInput = "0";
            else if (k === 'DEL') currentInput = currentInput.length > 1 ? currentInput.slice(0, -1) : "0";
            else if (k === 'DONE') {
                try {
                    const math = currentInput.replace(/×/g, '*').replace(/÷/g, '/');
                    const res = eval(math);
                    baseHKD = res / rates[targetCode];
                    closeModal('calc-modal');
                    render();
                } catch(e) { currentInput = "Error"; }
            } else { currentInput = currentInput === "0" ? k : currentInput + k; }
            document.getElementById('calc-screen').textContent = currentInput;
        }

        function showAddModal() {
            const container = document.getElementById('currency-options');
            container.innerHTML = '';
            Object.keys(currencyData).sort().forEach(code => {
                if (!activeList.includes(code)) {
                    const meta = currencyData[code];
                    const item = document.createElement('div');
                    item.className = 'opt-item';
                    item.innerHTML = `
                        <div class="flag-box" style="width:36px; height:36px;"><img src="https://flagcdn.com/w80/${meta.c}.png"></div>
                        <div style="flex:1;"><div style="font-weight:700;">${code}</div><div style="font-size:12px;color:var(--notion-subtext);">${meta.n}</div></div>
                    `;
                    item.onclick = () => { activeList.push(code); closeModal('add-modal'); render(); };
                    container.appendChild(item);
                }
            });
            document.getElementById('add-modal').classList.add('active');
        }

        function removeCode(code) { if (activeList.length > 1) { activeList = activeList.filter(c => c !== code); render(); } }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.getElementById('edit-btn').onclick = function() { isEditing = !isEditing; this.classList.toggle('active'); render(); };
        document.getElementById('header-add-btn').onclick = showAddModal;
        document.getElementById('footer-add-btn').onclick = showAddModal;
        document.getElementById('api-selector').onchange = sync;

        sync();
    </script>
</body>
</html>

