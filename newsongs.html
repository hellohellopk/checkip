<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Music HK Tracker v3.0</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Inter', -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .apple-glass {
            background: rgba(25, 25, 25, 0.8);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .song-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .song-item:active { transform: scale(0.97); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        
        /* Èü≥ÈáèÊ≥¢ÂãïÂãïÁï´ */
        .bars { display: flex; align-items: flex-end; gap: 2px; height: 12px; }
        .bar { width: 2px; background: #ef4444; animation: bounce 0.6s infinite alternate; }
        .bar:nth-child(2) { animation-delay: 0.2s; }
        .bar:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { from { height: 4px; } to { height: 12px; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const VERCEL_PROXY = "https://my-vercel-proxy-iota.vercel.app/api/proxy?url=";
        const CF_PROXY = "https://round-morning-c112.nippon-eb8.workers.dev/?url=";

        const DEFAULTS = {
            roomUrl: "https://music.apple.com/hk/room/6759756034",
            tgToken: "7973350853:AAG9O-4WEvDy2792Dux8DZqPvDGr3CapmxE",
            tgChatId: "-1003217464122"
        };

        const Icons = {
            Music: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
            Search: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Settings: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Check: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Loader: ({className}) => <svg className={`animate-spin ${className || 'w-6 h-6'}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Telegram: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Play: () => <svg className="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>,
            Pause: () => <svg className="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>,
            Refresh: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 0 1-9 9m-9-9a9 9 0 0 1 9-9m4 8H9m2-2-2 2 2 2"/></svg>
        };

        const App = () => {
            const getInitialConfig = () => {
                const saved = localStorage.getItem('am_tracker_config');
                if (saved) {
                    try { return JSON.parse(saved); } catch (e) { return DEFAULTS; }
                }
                return DEFAULTS;
            };

            const [config, setConfig] = useState(getInitialConfig());
            const [status, setStatus] = useState('idle');
            const [songs, setSongs] = useState([]);
            const [logs, setLogs] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [onlyChinese, setOnlyChinese] = useState(false);
            const [sendingMap, setSendingMap] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            
            // Audio Engine
            const [playingId, setPlayingId] = useState(null);
            const [loadingAudioId, setLoadingAudioId] = useState(null);
            const audioRef = useRef(new Audio());

            useEffect(() => {
                localStorage.setItem('am_tracker_config', JSON.stringify(config));
            }, [config]);

            const addLog = (m) => setLogs(p => [...p.slice(-25), m]);

            const cleanUrl = (url) => {
                if (!url) return '';
                try {
                    const u = new URL(url);
                    u.searchParams.delete('i');
                    return u.toString();
                } catch { return url; }
            };

            const extractTrackId = (url) => {
                try {
                    const u = new URL(url);
                    return u.searchParams.get('i');
                } catch { return null; }
            };

            const fetchData = async (url) => {
                try {
                    const res = await fetch(`${VERCEL_PROXY}${encodeURIComponent(url)}`);
                    if (!res.ok) throw new Error();
                    return await res.text();
                } catch {
                    const res = await fetch(`${CF_PROXY}${encodeURIComponent(url)}`);
                    return await res.text();
                }
            };

            // Ê†∏ÂøÉÔºöÈÄèÈÅé iTunes API Áç≤ÂèñÁ©©ÂÆöÁöÑË©¶ËÅΩÈÄ£Áµê
            const fetchPreviewUrl = async (trackId) => {
                if (!trackId) return null;
                try {
                    const apiUrl = `https://itunes.apple.com/lookup?id=${trackId}&country=HK`;
                    const res = await fetchData(apiUrl);
                    const json = JSON.parse(res);
                    return json.results?.[0]?.previewUrl || null;
                } catch (e) {
                    console.error("iTunes API Error", e);
                    return null;
                }
            };

            const handleTogglePlay = async (song) => {
                if (playingId === song.id) {
                    audioRef.current.pause();
                    setPlayingId(null);
                    return;
                }

                audioRef.current.pause();
                
                // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÈ†êË¶ΩÈÄ£ÁµêÔºåÁõ¥Êé•Êí≠Êîæ
                if (song.preview) {
                    audioRef.current.src = song.preview;
                    audioRef.current.load();
                    audioRef.current.play();
                    setPlayingId(song.id);
                    return;
                }

                // Âê¶ÂâáÔºåÂç≥ÊôÇÊäìÂèñ
                setLoadingAudioId(song.id);
                const trackId = extractTrackId(song.url);
                const pUrl = await fetchPreviewUrl(trackId);
                
                if (pUrl) {
                    song.preview = pUrl; // Â≠òÂÖ•Â∞çË±°Ôºå‰∏ãÊ¨°‰∏çÁî®ÂÜçÊäì
                    audioRef.current.src = pUrl;
                    audioRef.current.load();
                    audioRef.current.play();
                    setPlayingId(song.id);
                } else {
                    addLog(`‚ùå ÁÑ°Ê≥ïÁç≤Âèñ "${song.name}" ÁöÑË©¶ËÅΩÊ™î`);
                }
                setLoadingAudioId(null);
            };

            useEffect(() => {
                const a = audioRef.current;
                const end = () => setPlayingId(null);
                a.addEventListener('ended', end);
                return () => a.removeEventListener('ended', end);
            }, []);

            const sendToTelegram = async (song) => {
                if (sendingMap[song.id] === 'sending') return;
                setSendingMap(p => ({ ...p, [song.id]: 'sending' }));
                
                const message = `<b>${song.name}</b>\n${song.artist}\n\n${cleanUrl(song.url)}`;
                
                try {
                    const res = await fetch(`https://api.telegram.org/bot${config.tgToken}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: config.tgChatId,
                            text: message,
                            parse_mode: 'HTML'
                        })
                    });
                    if (!res.ok) throw new Error();
                    setSendingMap(p => ({ ...p, [song.id]: 'success' }));
                    setTimeout(() => setSendingMap(p => ({ ...p, [song.id]: null })), 3000);
                } catch (e) {
                    addLog(`‚ùå TG ÂêåÊ≠•Â§±Êïó: ${song.name}`);
                    setSendingMap(p => ({ ...p, [song.id]: 'error' }));
                }
            };

            const parseSongs = (html) => {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const script = doc.getElementById('serialized-server-data');
                let found = [];

                if (script) {
                    try {
                        const json = JSON.parse(script.innerText);
                        const data = Array.isArray(json) ? json[0] : json;
                        const search = (obj) => {
                            if (!obj || typeof obj !== 'object') return;
                            if (Array.isArray(obj.items)) {
                                obj.items.forEach(i => {
                                    if (i.title && i.artistName) {
                                        found.push({
                                            id: i.id || `${i.title}-${i.artistName}`,
                                            name: i.title,
                                            artist: i.artistName,
                                            url: i.contentDescriptor?.url || i.url || '',
                                            img: i.artwork?.url?.replace('{w}', '200').replace('{h}', '200').replace('{f}', 'jpg'),
                                            preview: null // ÂàùÂßã‰∏çÊäìÔºåÈªûÊìäÊôÇÂÜçÊäì‰ª•‰øùË≠â‰∏çÂ§±Êïà
                                        });
                                    }
                                });
                            }
                            Object.values(obj).forEach(search);
                        };
                        search(data);
                    } catch {}
                }
                return found.filter((v, i, a) => a.findIndex(t => (t.name === v.name && t.artist === v.artist)) === i);
            };

            const runSync = async () => {
                setStatus('loading');
                setSongs([]);
                setLogs([`üöÄ ÂïüÂãïÊéÉÊèèÂºïÊìé...`]);
                try {
                    const html = await fetchData(config.roomUrl);
                    const results = parseSongs(html);
                    if (results.length === 0) throw new Error("Êú™ËÉΩËÆÄÂèñË≥áÊñô");
                    setSongs(results);
                    addLog(`‚úÖ ÊàêÂäüÁç≤Âèñ ${results.length} È¶ñÊ≠åÊõ≤`);
                    setStatus('done');
                } catch (e) {
                    addLog(`‚ùå ÂêåÊ≠•Â§±Êïó: ${e.message}`);
                    setStatus('error');
                }
            };

            const filtered = useMemo(() => {
                return songs.filter(s => {
                    const matchText = (s.name + s.artist).toLowerCase().includes(searchTerm.toLowerCase());
                    const matchCN = onlyChinese ? /[\u4e00-\u9fa5]/.test(s.name + s.artist) : true;
                    return matchText && matchCN;
                });
            }, [songs, searchTerm, onlyChinese]);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col p-5 pb-24">
                    {/* Header */}
                    <header className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 bg-gradient-to-br from-red-600 to-rose-400 rounded-xl flex items-center justify-center shadow-lg shadow-red-500/30 text-white`}>
                                <Icons.Music />
                            </div>
                            <div>
                                <h1 className="text-xl font-extrabold tracking-tighter leading-none">TRACKER v3.0</h1>
                                <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-[2px] mt-1">Audio Engine Rebuilt</p>
                            </div>
                        </div>
                        <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-lg transition-colors ${showSettings ? 'bg-zinc-800 text-white' : 'text-zinc-600 hover:text-white'}`}>
                            <Icons.Settings />
                        </button>
                    </header>

                    {showSettings && (
                        <div className="mb-6 p-6 apple-glass rounded-[2rem] border-white/5 animate-slide-up shadow-2xl">
                            <div className="space-y-4">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-zinc-500 uppercase px-1">Apple Music Room URL</label>
                                    <input className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-xs font-mono text-zinc-300 outline-none focus:border-red-500/50 transition-all" value={config.roomUrl} onChange={e => setConfig({...config, roomUrl: e.target.value})} />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-zinc-500 uppercase px-1">Telegram Bot Token</label>
                                    <input className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-xs font-mono text-zinc-300 outline-none focus:border-red-500/50 transition-all" value={config.tgToken} onChange={e => setConfig({...config, tgToken: e.target.value})} />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-zinc-500 uppercase px-1">Telegram Chat ID</label>
                                    <input className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-xs font-mono text-zinc-300 outline-none focus:border-red-500/50 transition-all" value={config.tgChatId} onChange={e => setConfig({...config, tgChatId: e.target.value})} />
                                </div>
                                <button onClick={() => {setShowSettings(false); addLog("‚úÖ ÈÖçÁΩÆÂ∑≤ÂÑ≤Â≠ò");}} className="w-full bg-zinc-800 text-white font-bold py-3 rounded-xl text-xs uppercase tracking-widest mt-2">ÂÑ≤Â≠òÈÖçÁΩÆ</button>
                            </div>
                        </div>
                    )}

                    <div className="apple-glass rounded-[2rem] p-6 shadow-2xl mb-8 border-white/10 overflow-hidden relative">
                        <button onClick={runSync} disabled={status === 'loading'} className="w-full bg-white text-black font-black py-4 rounded-2xl hover:bg-zinc-200 active:scale-[0.98] transition-all disabled:opacity-50 flex items-center justify-center gap-3">
                            {status === 'loading' ? <Icons.Loader className="w-5 h-5" /> : <Icons.Refresh />}
                            ÂêåÊ≠•‰ªäÊó•Êñ∞Ê≠å
                        </button>
                        <div className="mt-4 bg-black/30 rounded-xl p-3 h-16 overflow-y-auto custom-scrollbar border border-white/5 font-mono text-[10px] text-zinc-600">
                            {logs.map((l, i) => <div key={i} className={`mb-1 ${l.includes('‚úÖ') ? 'text-green-500' : l.includes('‚ùå') ? 'text-red-500' : ''}`}>{l}</div>)}
                        </div>
                    </div>

                    {songs.length > 0 && (
                        <div className="flex-1 flex flex-col gap-5 animate-slide-up">
                            <div className="sticky top-2 z-20 apple-glass p-2.5 rounded-2xl flex gap-2 shadow-2xl">
                                <input className="flex-1 bg-transparent px-3 py-1 text-sm outline-none placeholder:text-zinc-700 font-medium" placeholder="ÊêúÂ∞ãÊ≠åÊâã„ÄÅÊ≠åÊõ≤..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <button onClick={() => setOnlyChinese(!onlyChinese)} className={`px-4 py-1.5 rounded-xl text-[10px] font-black transition-all ${onlyChinese ? 'bg-red-500 text-white shadow-lg shadow-red-500/20' : 'bg-white/5 text-zinc-600'}`}>‰∏≠Êñá</button>
                            </div>

                            <div className="space-y-3">
                                {filtered.map((s, i) => (
                                    <div key={s.id} className={`song-item p-3 apple-glass rounded-2xl flex items-center gap-4 border-transparent ${playingId === s.id ? 'border-red-500/40 bg-red-500/5' : 'hover:border-white/10'}`}>
                                        <div className="w-16 h-16 bg-zinc-900 rounded-xl overflow-hidden shrink-0 shadow-lg relative cursor-pointer group" onClick={() => handleTogglePlay(s)}>
                                            {s.img ? <img src={s.img} className={`w-full h-full object-cover transition-all duration-500 ${playingId === s.id ? 'scale-110 opacity-30 blur-[2px]' : 'group-hover:opacity-60'}`} /> : <div className="w-full h-full flex items-center justify-center text-zinc-800"><Icons.Music /></div>}
                                            <div className="absolute inset-0 flex items-center justify-center text-white">
                                                {loadingAudioId === s.id ? <Icons.Loader className="w-5 h-5" /> : 
                                                 playingId === s.id ? <div className="bars"><div className="bar"></div><div className="bar"></div><div className="bar"></div></div> : 
                                                 <div className="opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Play /></div>}
                                            </div>
                                            <div className="absolute top-1 left-1 bg-black/60 px-1 text-[8px] font-bold text-white/40 rounded">#{i+1}</div>
                                        </div>
                                        
                                        <div className="flex-1 min-w-0" onClick={() => handleTogglePlay(s)}>
                                            <h4 className={`text-sm font-bold truncate tracking-tight transition-colors ${playingId === s.id ? 'text-red-500' : 'text-zinc-200'}`}>{s.name}</h4>
                                            <p className="text-[11px] text-zinc-500 truncate font-semibold mt-0.5">{s.artist}</p>
                                        </div>

                                        <button 
                                            onClick={() => sendToTelegram(s)}
                                            className={`p-3.5 rounded-xl transition-all ${
                                                sendingMap[s.id] === 'success' ? 'bg-green-500/20 text-green-500' :
                                                'bg-white/5 text-blue-400 hover:bg-blue-500/10 active:scale-90'
                                            }`}
                                            title="ÂêåÊ≠•Ëá≥ TG (Â∑≤Ê∏ÖÊ¥óÈÄ£Áµê)"
                                        >
                                            {sendingMap[s.id] === 'sending' ? <Icons.Loader className="w-4 h-4" /> : 
                                             sendingMap[s.id] === 'success' ? <Icons.Check className="w-4 h-4" /> : 
                                             <Icons.Telegram />}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

