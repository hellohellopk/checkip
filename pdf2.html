<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF - Terminal Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            background: #1e1e1e; min-height: 100vh; padding: 20px; color: #00ff00;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            text-align: center; margin-bottom: 30px; padding: 20px;
            background: #2d2d2d; border-radius: 8px; border: 1px solid #3d3d3d;
        }
        header h1 {
            font-size: 1.5em; color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5); font-weight: 600;
        }
        header p { color: #888; margin-top: 10px; font-size: 0.9em; }
        .terminal-buttons { display: flex; gap: 8px; margin-bottom: 15px; }
        .terminal-btn { width: 12px; height: 12px; border-radius: 50%; }
        .btn-red { background: #ff5f56; }
        .btn-yellow { background: #ffbd2e; }
        .btn-green { background: #27c93f; }
        .main-content { display: grid; grid-template-columns: 280px 1fr; gap: 20px; margin-bottom: 40px; }
        .sidebar {
            background: #2d2d2d; border-radius: 8px; padding: 15px;
            height: fit-content; border: 1px solid #3d3d3d;
        }
        .sidebar-header { padding: 10px; margin-bottom: 15px; border-bottom: 1px solid #3d3d3d; }
        .sidebar-header h3 { color: #00ff00; font-size: 1em; font-weight: 600; }
        .tool-list { list-style: none; }
        .tool-item {
            padding: 10px 12px; margin-bottom: 6px; border-radius: 6px; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 10px;
            font-size: 0.9em; color: #888;
        }
        .tool-item:hover { background: rgba(0, 255, 0, 0.1); color: #00ff00; }
        .tool-item.active {
            background: rgba(0, 255, 0, 0.15); color: #00ff00; border-left: 3px solid #00ff00;
        }
        .workspace {
            background: #2d2d2d; border-radius: 8px; padding: 20px;
            border: 1px solid #3d3d3d; min-height: 600px;
        }
        .workspace h2 { color: #00ff00; margin-bottom: 10px; font-size: 1.5em; font-weight: 600; }
        .workspace p { color: #888; margin-bottom: 20px; font-size: 0.9em; }
        .upload-zone {
            border: 2px dashed #3d3d3d; border-radius: 8px; padding: 40px 20px;
            text-align: center; cursor: pointer; transition: all 0.3s;
            margin-bottom: 20px; background: rgba(0, 0, 0, 0.3);
        }
        .upload-zone:hover { background: rgba(0, 255, 0, 0.05); border-color: #00ff00; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .upload-text { font-size: 1em; color: #00ff00; margin-bottom: 5px; }
        .upload-subtext { color: #666; font-size: 0.85em; }
        #fileInput { display: none; }
        .file-list { margin-top: 15px; }
        .file-item {
            background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 6px;
            margin-bottom: 8px; display: flex; justify-content: space-between;
            align-items: center; border: 1px solid #3d3d3d;
        }
        .file-info-display { display: flex; align-items: center; gap: 10px; flex: 1; }
        .file-name-display { font-weight: 600; color: #00ff00; font-size: 0.9em; }
        .file-size-display { color: #666; font-size: 0.85em; }
        .remove-btn {
            background: #ff5f56; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.85em; font-family: inherit;
        }
        .remove-btn:hover { background: #ff3838; }
        .btn-primary {
            background: #27c93f; color: #1e1e1e; border: none; padding: 12px 30px;
            border-radius: 6px; font-size: 1em; cursor: pointer; transition: all 0.2s;
            margin-top: 15px; margin-right: 10px; display: inline-block;
            font-family: inherit; font-weight: 600;
        }
        .btn-primary:hover { background: #2edf48; transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .btn-download {
            background: #007aff; color: white; border: none; padding: 12px 30px;
            border-radius: 6px; font-size: 1em; cursor: pointer; transition: all 0.2s;
            margin-top: 15px; display: none; font-family: inherit; font-weight: 600;
        }
        .btn-download:hover { background: #0051d5; transform: translateY(-2px); }
        .controls {
            margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3);
            border-radius: 6px; border: 1px solid #3d3d3d;
        }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: block; margin-bottom: 5px; color: #00ff00;
            font-weight: 600; font-size: 0.9em;
        }
        .control-group input, .control-group select {
            width: 100%; padding: 8px; border: 1px solid #3d3d3d; border-radius: 4px;
            font-size: 0.9em; background: #1e1e1e; color: #00ff00; font-family: inherit;
        }
        .control-group input:focus, .control-group select:focus {
            outline: none; border-color: #00ff00;
        }
        .success-message {
            background: rgba(39, 201, 63, 0.2); border: 1px solid #27c93f; color: #27c93f;
            padding: 12px; border-radius: 6px; margin-top: 15px; display: none; font-size: 0.9em;
        }
        .error-message {
            background: rgba(255, 95, 86, 0.2); border: 1px solid #ff5f56; color: #ff5f56;
            padding: 12px; border-radius: 6px; margin-top: 15px; display: none; font-size: 0.9em;
        }
        .stats {
            display: flex; justify-content: space-around; background: #2d2d2d;
            border-radius: 8px; padding: 15px; margin-bottom: 30px; border: 1px solid #3d3d3d;
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 1.8em; font-weight: 600; display: block; color: #00ff00; }
        .stat-label { color: #666; font-size: 0.85em; }
        .info-box {
            background: rgba(0, 122, 255, 0.1); border-left: 3px solid #007aff;
            padding: 12px; margin-top: 15px; border-radius: 4px;
        }
        .info-box h4 { color: #007aff; margin-bottom: 6px; font-size: 0.9em; }
        .info-box p { color: #888; line-height: 1.6; font-size: 0.85em; }
        .image-preview-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px; margin-top: 15px;
        }
        .image-preview-item {
            position: relative; border: 1px solid #3d3d3d; border-radius: 6px;
            overflow: hidden; aspect-ratio: 1; background: rgba(0, 0, 0, 0.3);
        }
        .image-preview-item img, .image-preview-item canvas {
            width: 100%; height: 100%; object-fit: cover;
        }
        .image-preview-item .order-number {
            position: absolute; top: 5px; left: 5px;
            background: rgba(0, 255, 0, 0.9); color: #1e1e1e;
            padding: 4px 8px; border-radius: 3px; font-size: 0.8em; font-weight: 600;
        }
        .result-area {
            margin-top: 20px; padding: 15px; background: rgba(39, 201, 63, 0.1);
            border-radius: 6px; border: 1px solid #27c93f; display: none;
        }
        .result-area h3 { color: #27c93f; margin-bottom: 10px; font-size: 1.1em; }
        .result-info { color: #888; margin-bottom: 10px; font-size: 0.9em; }
        .progress-bar {
            width: 100%; height: 25px; background: rgba(0, 0, 0, 0.3);
            border-radius: 4px; overflow: hidden; margin: 15px 0; display: none;
            border: 1px solid #3d3d3d;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #27c93f 0%, #00ff00 100%);
            width: 0%; transition: width 0.3s; display: flex; align-items: center;
            justify-content: center; color: #1e1e1e; font-weight: 600; font-size: 0.85em;
        }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8em; }
            .workspace { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="terminal-buttons">
                <div class="terminal-btn btn-red"></div>
                <div class="terminal-btn btn-yellow"></div>
                <div class="terminal-btn btn-green"></div>
            </div>
            <h1>$ PDF --terminal</h1>
            <p>// 完全客戶端處理 • 文件永不上傳伺服器</p>
        </header>

        <div class="stats">
            <div class="stat-item">
                <span class="stat-number">100%</span>
                <span class="stat-label">隱私保護</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">∞</span>
                <span class="stat-label">無限制使用</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="fileCount">0</span>
                <span class="stat-label">已載入檔案</span>
            </div>
        </div>

        <div class="main-content">
            <aside class="sidebar">
                <div class="terminal-buttons">
                    <div class="terminal-btn btn-red"></div>
                    <div class="terminal-btn btn-yellow"></div>
                    <div class="terminal-btn btn-green"></div>
                </div>
                <div class="sidebar-header">
                    <h3>$ tools --list</h3>
                </div>
                <ul class="tool-list">
                    <li class="tool-item active" data-tool="merge">
                        <span>🔗</span><span>merge-pdf</span>
                    </li>
                    <li class="tool-item" data-tool="split">
                        <span>✂️</span><span>split-pdf</span>
                    </li>
                    <li class="tool-item" data-tool="rotate">
                        <span>↻</span><span>rotate-pages</span>
                    </li>
                    <li class="tool-item" data-tool="compress">
                        <span>🗜️</span><span>compress-pdf</span>
                    </li>
                    <li class="tool-item" data-tool="extract">
                        <span>📄</span><span>extract-pages</span>
                    </li>
                    <li class="tool-item" data-tool="delete">
                        <span>🗑️</span><span>delete-pages</span>
                    </li>
                    <li class="tool-item" data-tool="image">
                        <span>🖼️</span><span>image-to-pdf</span>
                    </li>
                    <li class="tool-item" data-tool="pdf-to-image">
                        <span>📷</span><span>pdf-to-image</span>
                    </li>
                </ul>
            </aside>
            <main class="workspace" id="workspace"></main>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global state - 添加 processedZipBlob 修復 PDF 轉圖片下載
        let currentTool = 'merge';
        let loadedFiles = [];
        let processedPdfBytes = null;
        let imageDataUrls = [];
        let processedZipBlob = null; // 修復: 儲存 ZIP blob

        // Tool definitions
        const tools = {
            merge: {
                title: '$ merge-pdf --input [files]',
                description: '// 將多個 PDF 文件合併為一個文件',
                multiple: true,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ merge-pdf --input [files]</h2>
                    <p>// 將多個 PDF 文件合併為一個文件</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <div class="upload-subtext">--multiple files accepted</div>
                        <input type="file" id="fileInput" accept=".pdf" multiple>
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 合併完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            split: {
                title: '$ split-pdf --output [directory]',
                description: '// 將 PDF 文件拆分為多個單獨的頁面',
                multiple: false,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ split-pdf --output [directory]</h2>
                    <p>// 將 PDF 文件拆分為多個單獨的頁面</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <div class="upload-subtext">--single file only</div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="info-box">
                        <h4>INFO</h4>
                        <p>// 此工具會將 PDF 的每一頁拆分為單獨的文件<br>// 所有文件將自動下載到您的裝置</p>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="success-message" id="successMsg">✓ 拆分完成！正在下載...</div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            rotate: {
                title: '$ rotate-pages --angle [degrees]',
                description: '// 旋轉 PDF 文件中的頁面',
                multiple: false,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ rotate-pages --angle [degrees]</h2>
                    <p>// 旋轉 PDF 文件中的頁面</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="controls" id="controls" style="display: none;">
                        <div class="control-group">
                            <label>--angle</label>
                            <select id="rotateAngle">
                                <option value="90">90° (順時針)</option>
                                <option value="180">180°</option>
                                <option value="270">270° (逆時針)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>--pages</label>
                            <select id="rotatePages">
                                <option value="all">all</option>
                                <option value="first">first</option>
                                <option value="last">last</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 旋轉完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            compress: {
                title: '$ compress-pdf --optimize',
                description: '// 減小 PDF 文件大小',
                multiple: false,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ compress-pdf --optimize</h2>
                    <p>// 減小 PDF 文件大小</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="info-box">
                        <h4>INFO</h4>
                        <p>// 此工具會優化 PDF 結構以減小文件大小<br>// 效果取決於原始 PDF 的內容和結構</p>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 壓縮完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            extract: {
                title: '$ extract-pages --range [pages]',
                description: '// 從 PDF 中提取特定頁面',
                multiple: false,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ extract-pages --range [pages]</h2>
                    <p>// 從 PDF 中提取特定頁面</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="controls" id="controls" style="display: none;">
                        <div class="control-group">
                            <label>--range (例如：1,3,5-7)</label>
                            <input type="text" id="pageRange" placeholder="1,3,5-7">
                        </div>
                    </div>
                    <div class="info-box">
                        <h4>SYNTAX</h4>
                        <p>// 單頁：1,2,3<br>// 範圍：1-5<br>// 混合：1,3,5-7,10</p>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 提取完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            delete: {
                title: '$ delete-pages --range [pages]',
                description: '// 從 PDF 中刪除指定頁面',
                multiple: false,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ delete-pages --range [pages]</h2>
                    <p>// 從 PDF 中刪除指定頁面</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="controls" id="controls" style="display: none;">
                        <div class="control-group">
                            <label>--range (例如：1,3,5-7)</label>
                            <input type="text" id="deletePages" placeholder="1,3,5-7">
                        </div>
                    </div>
                    <div class="info-box">
                        <h4>WARNING</h4>
                        <p>// 刪除的頁面將無法恢復<br>// 請確保輸入正確的頁面編號</p>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 刪除完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            image: {
                title: '$ image-to-pdf --input [images]',
                description: '// 將圖片文件轉換為 PDF',
                multiple: true,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ image-to-pdf --input [images]</h2>
                    <p>// 將圖片文件轉換為 PDF</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">🖼️</div>
                        <div class="upload-text">> 拖放圖片文件或點擊選擇</div>
                        <div class="upload-subtext">--format jpg,png</div>
                        <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" multiple>
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div id="imagePreviewGrid" class="image-preview-grid"></div>
                    <div class="info-box">
                        <h4>INFO</h4>
                        <p>// 圖片將按照上傳順序排列<br>// 每張圖片將保持原始尺寸創建為單獨的 PDF 頁面</p>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 轉換完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            },
            'pdf-to-image': {
                title: '$ pdf-to-image --format [type]',
                description: '// 將 PDF 頁面轉換為圖片',
                multiple: false,
                html: `
                    <div class="terminal-buttons">
                        <div class="terminal-btn btn-red"></div>
                        <div class="terminal-btn btn-yellow"></div>
                        <div class="terminal-btn btn-green"></div>
                    </div>
                    <h2>$ pdf-to-image --format [type]</h2>
                    <p>// 將 PDF 頁面轉換為 JPG 或 PNG 圖片</p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">> 拖放 PDF 文件或點擊選擇</div>
                        <div class="upload-subtext">--single file only</div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="controls" id="controls" style="display: none;">
                        <div class="control-group">
                            <label>--format</label>
                            <select id="imageFormat">
                                <option value="png">PNG (高質量)</option>
                                <option value="jpeg">JPG (較小)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>--quality (JPG only)</label>
                            <select id="imageQuality">
                                <option value="0.95">最高 (0.95)</option>
                                <option value="0.85" selected>高 (0.85)</option>
                                <option value="0.75">中 (0.75)</option>
                                <option value="0.6">低 (0.6)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>--dpi</label>
                            <select id="imageDPI">
                                <option value="1">72 DPI (螢幕)</option>
                                <option value="2" selected>144 DPI (高清)</option>
                                <option value="3">216 DPI (印刷)</option>
                                <option value="4">288 DPI (最高)</option>
                            </select>
                        </div>
                    </div>
                    <div id="imagePreviewGrid" class="image-preview-grid"></div>
                    <div class="info-box">
                        <h4>INFO</h4>
                        <p>// PNG: 無損格式，檔案較大<br>// JPG: 有損壓縮，檔案較小<br>// 所有頁面將被打包成 ZIP 文件</p>
                    </div>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                    <button class="btn-primary" id="processBtn" disabled>RUN</button>
                    <div class="result-area" id="resultArea">
                        <h3>✓ 轉換完成</h3>
                        <div class="result-info" id="resultInfo"></div>
                        <button class="btn-download" id="downloadBtn">DOWNLOAD ZIP</button>
                    </div>
                    <div class="error-message" id="errorMsg"></div>
                `
            }
        };

        function init() {
            loadTool(currentTool);
            setupToolSwitching();
        }

        function setupToolSwitching() {
            document.querySelectorAll('.tool-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.tool-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    currentTool = this.dataset.tool;
                    loadedFiles = [];
                    imageDataUrls = [];
                    processedPdfBytes = null;
                    processedZipBlob = null; // 修復: 重置 ZIP blob
                    updateFileCount();
                    loadTool(currentTool);
                });
            });
        }

        function loadTool(toolName) {
            const tool = tools[toolName];
            const workspace = document.getElementById('workspace');
            workspace.innerHTML = tool.html;
            setupUploadHandlers(tool.multiple);
            setupProcessButton();
        }

        function setupUploadHandlers(multiple) {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        async function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            const processBtn = document.getElementById('processBtn');

            loadedFiles = Array.from(files);
            imageDataUrls = [];
            fileList.innerHTML = '';

            if (currentTool === 'image') {
                const previewGrid = document.getElementById('imagePreviewGrid');
                if (previewGrid) {
                    previewGrid.innerHTML = '';
                    for (let i = 0; i < loadedFiles.length; i++) {
                        const file = loadedFiles[i];
                        if (file.type.startsWith('image/')) {
                            try {
                                const dataUrl = await fileToDataURL(file);
                                imageDataUrls.push(dataUrl);

                                const previewItem = document.createElement('div');
                                previewItem.className = 'image-preview-item';
                                previewItem.innerHTML = `
                                    <img src="${dataUrl}" alt="Image ${i + 1}">
                                    <div class="order-number">${i + 1}</div>
                                `;
                                previewGrid.appendChild(previewItem);
                            } catch (err) {
                                console.error(`Failed to load ${file.name}:`, err);
                            }
                        }
                    }
                }
            }

            if (currentTool === 'pdf-to-image' && loadedFiles.length > 0) {
                const file = loadedFiles[0];
                if (file.type === 'application/pdf') {
                    try {
                        await loadPDFPreview(file);
                    } catch (err) {
                        console.error('Failed to load PDF:', err);
                    }
                }
            }

            loadedFiles.forEach((file, i) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info-display">
                        <span>${file.type.includes('pdf') ? '📄' : '🖼️'}</span>
                        <div>
                            <div class="file-name-display">${file.name}</div>
                            <div class="file-size-display">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${i})">RM</button>
                `;
                fileList.appendChild(fileItem);
            });

            processBtn.disabled = loadedFiles.length === 0;

            const controls = document.getElementById('controls');
            if (controls && loadedFiles.length > 0) {
                controls.style.display = 'block';
            }

            updateFileCount();
        }

        async function loadPDFPreview(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

            const previewGrid = document.getElementById('imagePreviewGrid');
            if (!previewGrid) return;

            previewGrid.innerHTML = '';

            for (let i = 1; i <= Math.min(pdf.numPages, 12); i++) {
                const page = await pdf.getPage(i);
                const scale = 1.5;
                const viewport = page.getViewport({scale});

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({canvasContext: context, viewport: viewport}).promise;

                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.appendChild(canvas);
                previewItem.innerHTML += `<div class="order-number">第 ${i} 頁</div>`;
                previewGrid.appendChild(previewItem);
            }
        }

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function removeFile(index) {
            loadedFiles.splice(index, 1);
            imageDataUrls.splice(index, 1);
            handleFiles(loadedFiles);
        }

        function setupProcessButton() {
            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                processBtn.addEventListener('click', processTool);
            }
        }

        async function processTool() {
            const processBtn = document.getElementById('processBtn');
            const errorMsg = document.getElementById('errorMsg');
            const resultArea = document.getElementById('resultArea');

            try {
                processBtn.disabled = true;
                processBtn.textContent = 'PROCESSING...';
                errorMsg.style.display = 'none';
                if (resultArea) resultArea.style.display = 'none';

                switch(currentTool) {
                    case 'merge':
                        await mergePDFs();
                        break;
                    case 'split':
                        await splitPDF();
                        return;
                    case 'rotate':
                        await rotatePDF();
                        break;
                    case 'compress':
                        await compressPDF();
                        break;
                    case 'extract':
                        await extractPages();
                        break;
                    case 'delete':
                        await deletePages();
                        break;
                    case 'image':
                        await imageToPDF();
                        break;
                    case 'pdf-to-image':
                        await pdfToImages();
                        return; // 修復: pdf-to-image 自己處理結果顯示
                }

                if (resultArea && processedPdfBytes) {
                    const resultInfo = document.getElementById('resultInfo');
                    if (resultInfo) {
                        resultInfo.textContent = `// size: ${formatFileSize(processedPdfBytes.length)}`;
                    }
                    resultArea.style.display = 'block';

                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.style.display = 'inline-block';
                        downloadBtn.onclick = () => downloadProcessedPDF();
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                errorMsg.textContent = `ERROR: ${error.message}`;
                errorMsg.style.display = 'block';
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'RUN';
            }
        }

        function downloadProcessedPDF() {
            if (!processedPdfBytes) return;

            const filenames = {
                merge: 'merged.pdf',
                rotate: 'rotated.pdf',
                compress: 'compressed.pdf',
                extract: 'extracted.pdf',
                delete: 'deleted-pages.pdf',
                image: 'images-to-pdf.pdf'
            };

            downloadFile(processedPdfBytes, filenames[currentTool] || 'output.pdf', 'application/pdf');
        }

        // PDF Processing Functions
        async function mergePDFs() {
            const { PDFDocument } = PDFLib;
            const mergedPdf = await PDFDocument.create();

            for (const file of loadedFiles) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await PDFDocument.load(arrayBuffer);
                const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                copiedPages.forEach((page) => mergedPdf.addPage(page));
            }

            processedPdfBytes = await mergedPdf.save();
        }

        async function splitPDF() {
            const { PDFDocument } = PDFLib;
            const file = loadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await PDFDocument.load(arrayBuffer);
            const pageCount = pdf.getPageCount();

            const successMsg = document.getElementById('successMsg');
            if (successMsg) successMsg.style.display = 'block';

            for (let i = 0; i < pageCount; i++) {
                const newPdf = await PDFDocument.create();
                const [copiedPage] = await newPdf.copyPages(pdf, [i]);
                newPdf.addPage(copiedPage);
                const pdfBytes = await newPdf.save();
                downloadFile(pdfBytes, `page-${i + 1}.pdf`, 'application/pdf');
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            setTimeout(() => {
                if (successMsg) successMsg.style.display = 'none';
            }, 3000);
        }

        async function rotatePDF() {
            const { PDFDocument, degrees } = PDFLib;
            const file = loadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);

            const angle = parseInt(document.getElementById('rotateAngle').value);
            const pagesOption = document.getElementById('rotatePages').value;
            const pages = pdfDoc.getPages();

            if (pagesOption === 'all') {
                pages.forEach(page => page.setRotation(degrees(angle)));
            } else if (pagesOption === 'first') {
                pages[0].setRotation(degrees(angle));
            } else if (pagesOption === 'last') {
                pages[pages.length - 1].setRotation(degrees(angle));
            }

            processedPdfBytes = await pdfDoc.save();
        }

        async function compressPDF() {
            const { PDFDocument } = PDFLib;
            const file = loadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);

            processedPdfBytes = await pdfDoc.save();
        }

        async function extractPages() {
            const { PDFDocument } = PDFLib;
            const file = loadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);

            const pageRange = document.getElementById('pageRange').value;
            const pageIndices = parsePageRange(pageRange, pdfDoc.getPageCount());

            if (pageIndices.length === 0) {
                throw new Error('請輸入有效的頁面範圍');
            }

            const newPdf = await PDFDocument.create();
            const copiedPages = await newPdf.copyPages(pdfDoc, pageIndices);
            copiedPages.forEach(page => newPdf.addPage(page));

            processedPdfBytes = await newPdf.save();
        }

        async function deletePages() {
            const { PDFDocument } = PDFLib;
            const file = loadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);

            const deleteRange = document.getElementById('deletePages').value;
            const deleteIndices = parsePageRange(deleteRange, pdfDoc.getPageCount());

            if (deleteIndices.length === 0) {
                throw new Error('請輸入要刪除的頁面');
            }

            const allIndices = Array.from({length: pdfDoc.getPageCount()}, (_, i) => i);
            const keepIndices = allIndices.filter(i => !deleteIndices.includes(i));

            if (keepIndices.length === 0) {
                throw new Error('無法刪除所有頁面');
            }

            const newPdf = await PDFDocument.create();
            const copiedPages = await newPdf.copyPages(pdfDoc, keepIndices);
            copiedPages.forEach(page => newPdf.addPage(page));

            processedPdfBytes = await newPdf.save();
        }

        async function imageToPDF() {
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.create();

            for (let i = 0; i < imageDataUrls.length; i++) {
                const dataUrl = imageDataUrls[i];
                const file = loadedFiles[i];

                const base64Data = dataUrl.split(',')[1];
                const imageBytes = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));

                let image;
                if (file.type === 'image/png') {
                    image = await pdfDoc.embedPng(imageBytes);
                } else {
                    image = await pdfDoc.embedJpg(imageBytes);
                }

                const page = pdfDoc.addPage([image.width, image.height]);
                page.drawImage(image, {
                    x: 0,
                    y: 0,
                    width: image.width,
                    height: image.height,
                });
            }

            processedPdfBytes = await pdfDoc.save();
        }

        // 修復: PDF 轉圖片函數
        async function pdfToImages() {
            const format = document.getElementById('imageFormat').value;
            const quality = parseFloat(document.getElementById('imageQuality').value);
            const dpiScale = parseInt(document.getElementById('imageDPI').value);

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const resultArea = document.getElementById('resultArea');
            const processBtn = document.getElementById('processBtn');

            if (progressBar) progressBar.style.display = 'block';

            const file = loadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

            const zip = new JSZip();
            const totalPages = pdf.numPages;

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({scale: dpiScale});
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({canvasContext: context, viewport: viewport}).promise;

                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, mimeType, quality);
                });

                const extension = format === 'png' ? 'png' : 'jpg';
                zip.file(`page-${String(i).padStart(3, '0')}.${extension}`, blob);

                const progress = Math.round((i / totalPages) * 100);
                if (progressFill) {
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }
            }

            // 修復: 儲存 ZIP blob 到全局變量
            processedZipBlob = await zip.generateAsync({type: 'blob'});

            if (progressBar) progressBar.style.display = 'none';
            if (processBtn) {
                processBtn.disabled = false;
                processBtn.textContent = 'RUN';
            }

            if (resultArea) {
                const resultInfo = document.getElementById('resultInfo');
                if (resultInfo) {
                    resultInfo.textContent = `// pages: ${totalPages} | size: ${formatFileSize(processedZipBlob.size)} | format: ${format.toUpperCase()}`;
                }
                resultArea.style.display = 'block';

                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.onclick = downloadZipFile; // 修復: 綁定到獨立函數
                }
            }
        }

        // 修復: 獨立的 ZIP 下載函數
        function downloadZipFile() {
            if (!processedZipBlob) return;
            const url = URL.createObjectURL(processedZipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pdf-images.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        function parsePageRange(range, maxPages) {
            const pages = [];
            const parts = range.split(',');

            parts.forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(n => parseInt(n.trim()));
                    for (let i = start; i <= end && i <= maxPages; i++) {
                        if (i > 0) pages.push(i - 1);
                    }
                } else {
                    const pageNum = parseInt(part);
                    if (pageNum > 0 && pageNum <= maxPages) {
                        pages.push(pageNum - 1);
                    }
                }
            });

            return [...new Set(pages)].sort((a, b) => a - b);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function downloadFile(data, filename, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        function updateFileCount() {
            document.getElementById('fileCount').textContent = loadedFiles.length;
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>