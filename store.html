<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Price Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: #1e1e1e;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .terminal-header {
            background: #2d2d2d;
            border-radius: 8px 8px 0 0;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-red { background: #ff5f56; }
        .dot-yellow { background: #ffbd2e; }
        .dot-green { background: #27ca3f; }

        .terminal-title {
            margin-left: 12px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        .terminal-body {
            background: #1e1e1e;
            border: 1px solid #2d2d2d;
            border-radius: 0 0 8px 8px;
            padding: 20px;
            min-height: 400px;
        }

        h1 {
            color: #00d4aa;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
        }

        .search-box {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #404040;
        }

        .input-line {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            position: relative;
        }

        .prompt {
            color: #00d4aa;
            font-weight: 600;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 8px 30px 8px 0;
        }

        input::placeholder {
            color: #666;
        }

        .clear-btn {
            position: absolute;
            right: 0;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .clear-btn:hover {
            color: #ffffff;
        }

        .clear-btn svg {
            width: 16px;
            height: 16px;
        }

        .search-btn {
            background: transparent;
            color: #007acc;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            color: #00a0ff;
            background: rgba(0, 122, 204, 0.1);
        }

        .search-btn svg {
            width: 20px;
            height: 20px;
        }

        .currency-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #404040;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #007acc;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        .currency-label {
            color: #888;
            font-size: 12px;
        }

        #searchResults {
            background: #2d2d2d;
            border-radius: 6px;
            border: 1px solid #404040;
            min-height: 200px;
        }

        .search-results-list {
            padding: 12px;
        }

        .app-item {
            background: #1e1e1e;
            border: 1px solid #404040;
            margin-bottom: 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            gap: 16px;
            padding: 16px;
            transition: all 0.2s;
        }

        .app-item:last-child {
            margin-bottom: 0;
        }

        .app-item:hover {
            border-color: #007acc;
            background: #252525;
        }

        .app-item img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
        }

        .app-item-info {
            flex: 1;
        }

        .app-item-name {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .app-item-developer {
            color: #888;
            font-size: 13px;
        }

        .app-header {
            display: flex;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid #404040;
            align-items: center;
        }

        .app-header img {
            width: 80px;
            height: 80px;
            border-radius: 18px;
        }

        .app-details {
            flex: 1;
        }

        .app-name {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .app-developer {
            color: #888;
            font-size: 14px;
        }

        .price-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .price-box {
            background: #1e1e1e;
            padding: 16px 20px;
            text-decoration: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #404040;
            transition: all 0.2s;
            height: 60px;
            min-height: 60px;
            max-height: 60px;
        }

        .price-box:last-child {
            border-bottom: none;
        }

        .price-box:hover {
            background: #252525;
        }

        .price-box:nth-child(1) { border-left: 4px solid #ff5f56; }
        .price-box:nth-child(2) { border-left: 4px solid #ffbd2e; }
        .price-box:nth-child(3) { border-left: 4px solid #27ca3f; }
        .price-box:nth-child(4) { border-left: 4px solid #007acc; }
        .price-box:nth-child(5) { border-left: 4px solid #ff6b35; }

        .region {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
        }

        .price {
            color: #00d4aa;
            font-size: 14px;
            font-weight: 600;
        }

        .price-hkd {
            color: #ff5f56;
            font-size: 16px;
            font-weight: 600;
            margin-left: 16px;
        }

        .price-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-text {
            color: #888;
            padding: 20px;
            text-align: center;
            font-size: 13px;
        }

        .loading { color: #ffbd2e; }
        .error { color: #ff5f56; }
        .success { color: #27ca3f; }
    </style>
</head>
<body>
    <div class="container">
        <div class="terminal-header">
            <div class="terminal-dot dot-red"></div>
            <div class="terminal-dot dot-yellow"></div>
            <div class="terminal-dot dot-green"></div>
            <div class="terminal-title">app-price-checker — zsh — 120×40</div>
        </div>
        <div class="terminal-body">
            <h1>$ ./app-price-checker.sh</h1>
            
            <div class="search-box">
                <div class="input-line">
                    <span class="prompt">search &gt;</span>
                    <div class="input-wrapper">
                        <input type="text" id="searchInput" placeholder="輸入 App 名稱或 App Store 連結">
                        <button class="clear-btn" id="clearBtn" onclick="clearSearch()">
                            <svg viewBox="0 0 512 512" fill="currentColor">
                                <path d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c-9.4 9.4-9.4 24.6 0 33.9l47 47-47 47c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l47-47 47 47c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-47-47 47-47c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-47 47-47-47c-9.4-9.4-24.6-9.4-33.9 0z"/>
                            </svg>
                        </button>
                    </div>
                    <button class="search-btn" onclick="searchApp()">
                        <svg viewBox="0 0 512 512" fill="currentColor">
                            <path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/>
                        </svg>
                    </button>
                </div>
                <div class="currency-toggle">
                    <span class="currency-label">當地貨幣</span>
                    <div class="toggle-switch active" id="currencyToggle" onclick="toggleCurrency()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="currency-label">香港港幣</span>
                </div>
            </div>

            <div id="searchResults">
                <div class="terminal-text">等待輸入...</div>
            </div>
        </div>
    </div>

    <script>
        const regions = [
            { code: 'hk', name: '🇭🇰 香港', currency: 'HKD', symbol: 'HK$' },
            { code: 'us', name: '🇺🇸 美國', currency: 'USD', symbol: '$' },
            { code: 'jp', name: '🇯🇵 日本', currency: 'JPY', symbol: '¥' },
            { code: 'tr', name: '🇹🇷 土耳其', currency: 'TRY', symbol: '₺' },
            { code: 'in', name: '🇮🇳 印度', currency: 'INR', symbol: '₹' }
        ];

        let showHKD = true;
        let exchangeRates = {};

        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');

        searchInput.addEventListener('input', function() {
            if (this.value.length > 0) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
            }
        });

        function clearSearch() {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchInput.focus();
        }

        async function getExchangeRates() {
            try {
                const apis = [
                    'https://api.exchangerate-api.com/v4/latest/usd',
                    'https://api.exchangerate-api.com/v4/latest/hkd',
                    'https://api.exchangerate-api.com/v4/latest/inr',
                    'https://api.exchangerate-api.com/v4/latest/try'
                ];

                const responses = await Promise.all(apis.map(api => fetch(api).catch(err => {
                    console.error('匯率 API 錯誤:', err);
                    return null;
                })));
                
                const validResponses = responses.filter(r => r !== null);
                if (validResponses.length === 0) {
                    throw new Error('所有匯率 API 請求失敗');
                }
                
                const data = await Promise.all(validResponses.map(r => r.json()));

                exchangeRates = {
                    'USD': data[0]?.rates?.HKD || 7.8,
                    'HKD': 1,
                    'JPY': data[1]?.rates?.JPY || 19.45,
                    'TRY': data[1]?.rates?.TRY || 5.38,
                    'INR': data[1]?.rates?.INR || 11.32
                };
            } catch (error) {
                console.error('無法獲取匯率:', error);
                exchangeRates = {
                    'USD': 7.8,
                    'HKD': 1,
                    'JPY': 19.45,
                    'TRY': 5.38,
                    'INR': 11.32
                };
            }
        }

        function convertToHKD(price, currency) {
            if (!exchangeRates[currency] || price === 0) return null;
            
            let hkdPrice;
            if (currency === 'USD') {
                hkdPrice = price * exchangeRates['USD'];
            } else if (currency === 'HKD') {
                hkdPrice = price;
            } else {
                hkdPrice = price / exchangeRates[currency];
            }
            
            return `HK$ ${hkdPrice.toFixed(2)}`;
        }

        function getCurrencySymbol(currency) {
            const region = regions.find(r => r.currency === currency);
            return region ? region.symbol : currency;
        }

        function toggleCurrency() {
            showHKD = !showHKD;
            const toggle = document.getElementById('currencyToggle');
            toggle.classList.toggle('active', showHKD);

            const currentTrackId = document.getElementById('searchResults').dataset.trackId;
            if (currentTrackId) {
                displayAppWithPrices(currentTrackId);
            }
        }

        function extractAppId(input) {
            const patterns = [
                /id(\d+)/i,
                /\/app\/[^\/]+\/id(\d+)/i,
                /apps\.apple\.com\/.*\/id(\d+)/i
            ];

            for (const pattern of patterns) {
                const match = input.match(pattern);
                if (match) {
                    return match[1];
                }
            }

            return null;
        }

        async function getAppPrice(appId, country) {
            try {
                const response = await fetch(`https://itunes.apple.com/lookup?id=${appId}&country=${country}`, {
                    timeout: 10000
                });
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const app = data.results[0];
                    const price = app.price || 0;
                    const currency = app.currency;
                    const symbol = getCurrencySymbol(currency);
                    let priceText = price === 0 ? 'FREE' : `${symbol} ${price}`;
                    let hkdText = '';

                    if (showHKD && price > 0 && currency !== 'HKD') {
                        const hkdPrice = convertToHKD(price, currency);
                        if (hkdPrice) hkdText = hkdPrice;
                    }

                    return { price: priceText, hkdPrice: hkdText, url: app.trackViewUrl };
                }
                return { price: 'N/A', hkdPrice: '', url: '#' };
            } catch (error) {
                console.error(`獲取 ${country} 價格失敗:`, error);
                return { price: 'ERROR', hkdPrice: '', url: '#' };
            }
        }

        async function displayAppWithPrices(trackId) {
            const searchDiv = document.getElementById('searchResults');
            searchDiv.dataset.trackId = trackId;
            
            searchDiv.innerHTML = '<div class="terminal-text loading">載入中...</div>';

            if (showHKD && Object.keys(exchangeRates).length === 0) {
                await getExchangeRates();
            }

            try {
                const response = await fetch(`https://itunes.apple.com/lookup?id=${trackId}&country=us`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const app = data.results[0];
                    
                    const promises = regions.map(async (region) => {
                        const priceData = await getAppPrice(trackId, region.code);
                        return { region: region.name, code: region.code, ...priceData };
                    });

                    const prices = await Promise.all(promises);

                    let html = `
                        <div class="app-header">
                            <img src="${app.artworkUrl100}" alt="${app.trackName}">
                            <div class="app-details">
                                <div class="app-name">${app.trackName}</div>
                                <div class="app-developer">${app.artistName}</div>
                            </div>
                        </div>
                        <div class="price-grid">
                            ${prices.map(p => `
                                <a href="${p.url}" target="_blank" class="price-box">
                                    <div class="region">${p.region}</div>
                                    <div class="price-container">
                                        <div class="price">${p.price}</div>
                                        ${p.hkdPrice ? `<div class="price-hkd">${p.hkdPrice}</div>` : ''}
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    `;
                    
                    searchDiv.innerHTML = html;
                } else {
                    searchDiv.innerHTML = '<div class="terminal-text error">找不到該 App</div>';
                }
            } catch (error) {
                console.error('查詢失敗:', error);
                searchDiv.innerHTML = '<div class="terminal-text error">網路連線問題，請檢查連線或稍後再試</div>';
            }
        }

        async function searchApp() {
            const query = searchInput.value;
            const searchDiv = document.getElementById('searchResults');

            if (!query) {
                searchDiv.innerHTML = '<div class="terminal-text error">ERROR: 請輸入 App 名稱或連結</div>';
                return;
            }

            searchDiv.innerHTML = '<div class="terminal-text loading">搜尋中...</div>';

            const appId = extractAppId(query);
            
            if (appId) {
                await displayAppWithPrices(appId);
            } else {
                try {
                    const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&country=us&entity=software&limit=5`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();

                    if (data.results.length === 0) {
                        searchDiv.innerHTML = '<div class="terminal-text error">找不到相關 App</div>';
                        return;
                    }

                    // 確保至少顯示 3 個，最多 5 個
                    const results = data.results.slice(0, 5);
                    
                    if (results.length === 1) {
                        // 如果只有 1 個結果，直接顯示價格
                        await displayAppWithPrices(results[0].trackId);
                    } else if (results.length === 2) {
                        // 如果只有 2 個結果，也直接顯示第一個的價格
                        await displayAppWithPrices(results[0].trackId);
                    } else {
                        // 3-5 個結果，顯示列表讓使用者選擇
                        let html = '<div class="search-results-list">';
                        results.forEach((app) => {
                            html += `
                                <div class="app-item" onclick="displayAppWithPrices(${app.trackId})">
                                    <img src="${app.artworkUrl100}" alt="${app.trackName}">
                                    <div class="app-item-info">
                                        <div class="app-item-name">${app.trackName}</div>
                                        <div class="app-item-developer">${app.artistName}</div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        searchDiv.innerHTML = html;
                    }
                } catch (error) {
                    console.error('搜尋失敗:', error);
                    searchDiv.innerHTML = '<div class="terminal-text error">網路連線問題，請檢查連線或稍後再試</div>';
                }
            }
        }

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchApp();
        });

        getExchangeRates();
    </script>
</body>
</html>
