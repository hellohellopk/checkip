<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Price Checker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Mac Terminal 主題 */
        body { 
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace; 
            background: #000; 
            color: #00ff00; 
            padding: 20px;
            line-height: 1.6;
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(0, 0, 0, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 255, 0, 0.15);
        }

        /* Terminal 標題欄 */
        .terminal-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .terminal-dots {
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-red { background: #ff5f56; box-shadow: 0 0 8px #ff5f56; }
        .dot-yellow { background: #ffbd2e; box-shadow: 0 0 8px #ffbd2e; }
        .dot-green { background: #27c93f; box-shadow: 0 0 8px #27c93f; }

        h1 { 
            font-size: 20px; 
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            margin-left: 15px;
        }

        /* 匯率信息 - 藍色 */
        .rate-update { 
            color: #5ac8fa;
            font-size: 11px; 
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* 搜索框 */
        input { 
            width: 100%; 
            padding: 12px 15px; 
            background: #1a1a1a; 
            border: 1px solid #00ff00; 
            color: #00ff00; 
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px; 
            border-radius: 6px; 
            margin-bottom: 25px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
        }

        input::placeholder { 
            color: rgba(0, 255, 0, 0.5);
        }

        #searchResults { margin-top: 20px; }

        /* 價格網格 */
        .price-grid { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin-top: 20px; 
        }

        /* 價格行 - 彩虹漸變邊框 */
        .price-box { 
            background: rgba(0, 0, 0, 0.5); 
            padding: 14px 18px; 
            border-radius: 8px; 
            border: 1px solid transparent;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)),
                linear-gradient(90deg, #ff5f56, #ffbd2e, #27c93f, #5ac8fa, #af52de);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .price-box:hover { 
            transform: translateX(6px);
            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
        }

        .price-box-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        /* 地區標籤 - 紅色 */
        .country { 
            color: #ff5f56;
            font-weight: 700; 
            font-size: 15px; 
            min-width: 110px;
            text-shadow: 0 0 8px rgba(255, 95, 86, 0.5);
        }

        .price-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* 價格 - 綠色 */
        .price { 
            color: #27c93f;
            font-size: 16px; 
            font-weight: 700;
            text-shadow: 0 0 8px rgba(39, 201, 63, 0.5);
        }

        /* 港幣 - 藍色 */
        .price-hkd { 
            color: #5ac8fa;
            font-size: 12px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* 按鈕 - 黃色漸變 */
        .iap-button { 
            background: linear-gradient(135deg, #ffbd2e 0%, #ff9500 100%);
            color: #000; 
            border: none; 
            padding: 9px 18px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 110px;
            box-shadow: 0 0 15px rgba(255, 189, 46, 0.4);
            font-family: 'SF Mono', Monaco, monospace;
        }

        .iap-button:hover { 
            background: linear-gradient(135deg, #ffd60a 0%, #ffbd2e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 189, 46, 0.6);
        }

        .iap-button:disabled { 
            background: #333; 
            color: #666; 
            cursor: not-allowed;
            box-shadow: none;
        }

        /* --- 更改：App 信息卡片佈局 --- */
        .app-info { 
            background: rgba(0, 0, 0, 0.6);
            padding: 25px; 
            border-radius: 10px; 
            border: 1px solid rgba(0, 255, 0, 0.3);
            margin-bottom: 25px;
            display: flex;
            flex-direction: column; /* 標題在上, 內容在下 */
            justify-content: flex-start;
            gap: 15px; /* 標題和內容的間距 */
            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.15);
        }

        /* --- 新增：卡片內容體 (詳細資訊 + 圖示) --- */
        .app-info-body {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 25px;
            width: 100%;
        }

        .app-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1; /* 佔據所有剩餘空間, 將圖示推到右側 */
        }

        /* App 名稱 - 橙色 */
        .app-name { 
            font-size: 24px; /* --- 更改：字體稍大 --- */
            font-weight: 700; 
            color: #ff9500;
            text-shadow: 0 0 10px rgba(255, 149, 0, 0.6);
            width: 100%; /* 確保佔滿寬度 */
            line-height: 1.3; /* 改善長標題換行 */
        }

        /* 開發者 - 紫色 */
        .app-dev { 
            color: #af52de;
            font-size: 15px;
            text-shadow: 0 0 8px rgba(175, 82, 222, 0.4);
        }

        /* --- 更改：Size/Version 已在此處一行顯示 --- */
        .app-meta {
            display: flex;
            flex-wrap: wrap; /* 允許在小螢幕換行 */
            gap: 20px;
            font-size: 12px;
            color: #5ac8fa;
            margin-top: 6px;
        }

        .app-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* App 圖示 */
        .app-icon {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            flex-shrink: 0;
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(0, 255, 0, 0.2);
            border: 2px solid rgba(0, 255, 0, 0.3);
        }

        /* 內購區域 */
        .iap-container { 
            margin-top: 12px; 
            animation: slideDown 0.3s ease; 
        }

        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .iap-section { 
            background: rgba(0, 0, 0, 0.7);
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid rgba(0, 255, 0, 0.2);
            margin-left: 130px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* 標題 - 綠色 */
        .section-title { 
            color: #27c93f;
            font-weight: 700; 
            margin-bottom: 12px; 
            font-size: 13px;
            text-shadow: 0 0 8px rgba(39, 201, 63, 0.5);
        }

        .iap-list { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        /* 內購項目 - 彩虹邊框 */
        .iap-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 12px; 
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px; 
            border-left: 3px solid;
            border-image: linear-gradient(180deg, #ff5f56, #ffbd2e, #27c93f, #5ac8fa, #af52de) 1;
            transition: all 0.3s;
        }

        .iap-item:hover { 
            background: rgba(0, 255, 0, 0.05);
            transform: translateX(4px);
        }

        /* 內購名稱 - 白色帶綠光 */
        .iap-name { 
            color: #e0e0e0;
            flex: 1; 
            font-size: 12px; 
            line-height: 1.4;
        }

        .iap-price-group { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            margin-left: 12px; 
        }

        /* 內購價格 - 黃色 */
        .iap-price { 
            color: #ffbd2e;
            font-weight: 700; 
            font-size: 13px; 
            white-space: nowrap;
            text-shadow: 0 0 8px rgba(255, 189, 46, 0.5);
        }

        /* 內購港幣 - 藍色 */
        .iap-price-hkd { 
            color: #5ac8fa;
            font-size: 10px; 
            margin-top: 3px;
            text-shadow: 0 0 5px rgba(90, 200, 250, 0.3);
        }

        /* 加載/錯誤信息 */
        .iap-loading { 
            padding: 15px; 
            text-align: center; 
            color: #27c93f;
            background: rgba(39, 201, 63, 0.1);
            border-radius: 6px; 
            font-size: 12px;
            text-shadow: 0 0 8px rgba(39, 201, 63, 0.5);
        }

        .iap-none { 
            padding: 15px; 
            text-align: center; 
            color: #666;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px; 
            font-size: 12px;
        }

        .loading-spinner { 
            animation: spin 1s linear infinite; 
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* 錯誤 - 紅色 */
        .error-text { 
            color: #ff5f56;
            text-shadow: 0 0 10px rgba(255, 95, 86, 0.6);
        }

        /* 加載 - 綠色 */
        .loading-text { 
            color: #27c93f;
            text-shadow: 0 0 10px rgba(39, 201, 63, 0.6);
        }

        /* 響應式 */
        @media (max-width: 768px) {
            .price-box { flex-direction: column; align-items: flex-start; }
            .price-box-left { width: 100%; }
            .iap-button { width: 100%; }
            .iap-section { margin-left: 0; }
        }

        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 10px;
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff5f56, #ffbd2e, #27c93f, #5ac8fa, #af52de);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="terminal-header">
            <div class="terminal-dots">
                <div class="dot dot-red"></div>
                <div class="dot dot-yellow"></div>
                <div class="dot dot-green"></div>
            </div>
            <h1>$ app-price-checker</h1>
        </div>

        <div class="rate-update" id="rateUpdate">// Loading exchange rates...</div>
        <input type="text" id="searchInput" placeholder="$ search app_name or paste app_store_link">
        <div id="searchResults"></div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const iapCache = new Map();
        let currentApp = null;
        let EXCHANGE_RATES = {};

        function log(msg) { console.log(`[${new Date().toLocaleTimeString()}] ${msg}`); }

        async function loadExchangeRates() {
            try {
                log('📊 加載實時匯率...');
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                const data = await response.json();

                if (data && data.rates) {
                    EXCHANGE_RATES = {
                        'HKD': 1.0,
                        'USD': 1 / data.rates.USD,
                        'JPY': 1 / data.rates.JPY,
                        'TRY': 1 / data.rates.TRY,
                        'INR': 1 / data.rates.INR,
                        'EUR': 1 / data.rates.EUR,
                        'GBP': 1 / data.rates.GBP,
                        'AUD': 1 / data.rates.AUD,
                        'CAD': 1 / data.rates.CAD
                    };

                    log('✓ 匯率已加載');
                    const updateTime = new Date(data.time_last_updated * 1000);
                    document.getElementById('rateUpdate').textContent = 
                        `// Exchange rates updated: ${updateTime.toLocaleString('zh-TW')} | USD=${EXCHANGE_RATES.USD.toFixed(2)} | TRY=${EXCHANGE_RATES.TRY.toFixed(4)}`;
                    return true;
                }
            } catch (error) {
                log(`❌ 匯率加載失敗: ${error.message}`);
                document.getElementById('rateUpdate').textContent = '// Warning: Using default exchange rates';
                EXCHANGE_RATES = { 'HKD': 1.0, 'USD': 7.75, 'JPY': 0.0508, 'TRY': 0.1852, 'INR': 0.088 };
                return false;
            }
        }

        function parsePrice(priceStr) {
            if (!priceStr) return null;
            let cleaned = priceStr.replace(/\s+/g, '');
            const lastComma = cleaned.lastIndexOf(',');
            const lastDot = cleaned.lastIndexOf('.');

            if (lastComma > lastDot && lastComma > 0) {
                const afterComma = cleaned.substring(lastComma + 1);
                if (afterComma.length === 2) {
                    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
                } else {
                    cleaned = cleaned.replace(/,/g, '');
                }
            } else if (lastDot > lastComma && lastDot > 0) {
                cleaned = cleaned.replace(/,/g, '');
            }

            const match = cleaned.match(/([\d.]+)/);
            return match ? parseFloat(match[1]) : null;
        }

        function convertToHKD(priceStr, currencyCode) {
            if (!priceStr) return null;
            const amount = parsePrice(priceStr);
            if (!amount || amount === 0 || isNaN(amount)) return null;

            let currency = currencyCode; 

            if (!currency) {
                if (priceStr.includes('$') && !priceStr.includes('HK$')) currency = 'USD';
                else if (priceStr.includes('HK$')) currency = 'HKD';
                else if (priceStr.includes('¥') || priceStr.includes('JPY')) currency = 'JPY';
                else if (priceStr.includes('₺') || priceStr.includes('TRY')) currency = 'TRY';
                else if (priceStr.includes('₹') || priceStr.includes('INR')) currency = 'INR';
                else if (priceStr.includes('€') || priceStr.includes('EUR')) currency = 'EUR';
                else if (priceStr.includes('£') || priceStr.includes('GBP')) currency = 'GBP';
                else currency = 'USD'; 
            }

            const rate = EXCHANGE_RATES[currency] || 1;
            const hkdAmount = amount * rate;
            return { original: priceStr, hkd: `≈ HK$ ${hkdAmount.toFixed(2)}`, amount: hkdAmount, currency: currency };
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        loadExchangeRates();

        document.getElementById('searchInput').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    if (Object.keys(EXCHANGE_RATES).length === 0) await loadExchangeRates();

                    if (query.startsWith('https://apps.apple.com')) {
                        const match = query.match(/\/id(\d+)/); 
                        if (match && match[1]) {
                            const appId = match[1];
                            await searchAppById(appId); 
                        } else {
                            document.getElementById('searchResults').innerHTML = '<div class="error-text">// Error: Invalid App Store URL</div>';
                        }
                    } else {
                        await searchApp(query); 
                    }
                }
            }
        });

        async function searchApp(query) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading-text">// Searching...</div>';

            try {
                const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&country=us&entity=software&limit=1`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    currentApp = data.results[0];
                    await displayApp(currentApp);
                } else {
                    resultsDiv.innerHTML = '<div class="error-text">// Error: App not found</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error-text">// Error: Search failed</div>';
            }
        }

        async function searchAppById(appId) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading-text">// Looking up App ID...</div>';

            try {
                const response = await fetch(`https://itunes.apple.com/lookup?id=${appId}&country=us&entity=software`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    currentApp = data.results[0];
                    await displayApp(currentApp); 
                } else {
                    resultsDiv.innerHTML = '<div class="error-text">// Error: App ID not found</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error-text">// Error: Lookup failed</div>';
            }
        }


        // --- 更改：更新 HTML 結構 ---
        async function displayApp(app) {
            const countries = [
                { name: '🇺🇸 US', code: 'us', currency: 'USD' },
                { name: '🇭🇰 HK', code: 'hk', currency: 'HKD' },
                { name: '🇯🇵 JP', code: 'jp', currency: 'JPY' },
                { name: '🇹🇷 TR', code: 'tr', currency: 'TRY' },
                { name: '🇮🇳 IN', code: 'in', currency: 'INR' }
            ];

            // 1. 建立 App 資訊卡片
            let html = '<div class="app-info">';
            
            // 標題 (佔滿頂部)
            html += '<div class="app-name">' + app.trackName + '</div>';

            // 內容易器 (詳細資訊 + 圖示)
            html += '<div class="app-info-body">';
            
            // 左側詳細資訊
            html += '<div class="app-details">';
            html += '<div class="app-dev">// ' + app.artistName + '</div>';
            
            // Size/Version (已在同一行)
            html += '<div class="app-meta">';
            if (app.fileSizeBytes) {
                html += '<div class="app-meta-item">📦 ' + formatFileSize(parseInt(app.fileSizeBytes)) + '</div>';
            }
            if (app.version) {
                html += '<div class="app-meta-item">🔖 v' + app.version + '</div>';
            }
            html += '</div>'; // 結束 .app-meta
            html += '</div>'; // 結束 .app-details

            // 右側圖示
            if (app.artworkUrl100 || app.artworkUrl512) {
                const iconUrl = (app.artworkUrl512 || app.artworkUrl100).replace('100x100', '512x512');
                html += '<img src="' + iconUrl + '" class="app-icon" alt="' + app.trackName + '">';
            }
            
            html += '</div>'; // 結束 .app-info-body
            html += '</div>'; // 結束 .app-info

            // 2. 建立價格網格 (與之前相同)
            html += '<div class="price-grid">';

            const promises = countries.map(country =>
                fetch(`https://itunes.apple.com/lookup?id=${app.trackId}&country=${country.code}`)
                    .then(res => res.json())
                    .then(data => ({ data, country })) 
            );

            const results = await Promise.allSettled(promises);
            let priceHtml = '';

            for (const [index, result] of results.entries()) {
                const country = countries[index]; 

                if (result.status === 'fulfilled') {
                    const { data } = result.value;
                    if (data.results && data.results.length > 0) {
                        const appData = data.results[0];
                        const priceNum = appData.price;
                        const currency = appData.currency;

                        let priceDisplay, hkdDisplay = '';

                        if (priceNum === 0) {
                            priceDisplay = 'FREE';
                        } else {
                            priceDisplay = currency + ' ' + priceNum;
                            const converted = convertToHKD(priceNum.toString(), currency);
                            if (converted && currency !== 'HKD') {
                                hkdDisplay = '<div class="price-hkd">' + converted.hkd + '</div>';
                            }
                        }
                        
                        priceHtml += '<div class="price-box">';
                        priceHtml += '<div class="price-box-left">';
                        priceHtml += '<div class="country">' + country.name + '</div>';
                        priceHtml += '<div class="price-info"><div class="price">' + priceDisplay + '</div>' + hkdDisplay + '</div>';
                        priceHtml += '</div>';
                        priceHtml += '<button class="iap-button" onclick="loadIAP(this, \'' + country.code + '\', \'' + app.trackId + '\', \'' + country.name + '\', \'' + country.currency + '\')">VIEW IAP</button>';
                        priceHtml += '</div>';
                    } else {
                        priceHtml += '<div class="price-box"><div class="price-box-left"><div class="country">' + country.name + '</div><div class="price-info"><div class="price" style="color: #666;">N/A</div></div></div></div>';
                    }
                } else {
                    log(`❌ ${country.name} 價格獲取失敗: ${result.reason}`);
                    priceHtml += '<div class="price-box"><div class="price-box-left"><div class="country">' + country.name + '</div><div class="price-info"><div class="price" style="color: #666;">ERROR</div></div></div></div>';
                }
            }

            html += priceHtml; 
            html += '</div>'; 
            document.getElementById('searchResults').innerHTML = html;
        }

        async function loadIAP(button, countryCode, appId, countryName, currency) {
            log(`=== ${countryName} IAP ===`);
            button.disabled = true;
            button.innerHTML = 'LOADING...';

            const priceBox = button.closest('.price-box');
            let container = priceBox.nextElementSibling;

            if (!container || !container.classList.contains('iap-container')) {
                container = document.createElement('div');
                container.className = 'iap-container';
                priceBox.parentElement.insertBefore(container, priceBox.nextSibling);
            }

            container.innerHTML = '<div class="iap-loading"><span class="loading-spinner">⏳</span> Fetching IAP data...</div>';

            try {
                const iapData = await getIAPByRegion(appId, countryCode, currency);

                if (!iapData || iapData.length === 0) {
                    container.innerHTML = '<div class="iap-none">// No in-app purchases</div>';
                    button.innerHTML = 'CHECKED ✓';
                } else {
                    let html = '<div class="iap-section"><div class="section-title">// ' + countryName + ' In-App Purchases (' + iapData.length + ')</div><div class="iap-list">';
                    iapData.forEach(item => {
                        html += '<div class="iap-item"><span class="iap-name">' + item.title + '</span><div class="iap-price-group"><span class="iap-price">' + item.price + '</span>';
                        if (item.hkd) html += '<span class="iap-price-hkd">' + item.hkd + '</span>';
                        html += '</div></div>';
                    });
                    html += '</div></div>';
                    container.innerHTML = html;
                    button.innerHTML = 'LOADED (' + iapData.length + ')';
                }
            } catch (e) {
                log(`❌ ${e.message}`);
                container.innerHTML = '<div class="iap-none">// Error: Failed to fetch</div>';
                button.innerHTML = 'RETRY';
                button.disabled = false;
            }
        }

        async function getIAPByRegion(appId, countryCode, currency) {
            const cacheKey = `${appId}_${countryCode}`;
            if (iapCache.has(cacheKey)) { log('✓ Cache'); return iapCache.get(cacheKey); }

            let html = ''; // 讓 html 在 try-catch 外部可見

            try {
                let url = currentApp && currentApp.trackViewUrl ? 
                    currentApp.trackViewUrl.replace(/\/[a-z]{2}\//, `/${countryCode}/`) : 
                    `https://apps.apple.com/${countryCode}/app/id${appId}`;

                log(`URL: ${url}`);
                const proxyUrl = CORS_PROXY + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                html = await response.text(); // 將 html 賦值
                log(`✓ ${html.length} chars`);
                
                const match = html.match(/<script id="shoebox-ember-data-store" type="application\/json">([\s\S]*?)<\/script>/);
                if (!match || !match[1]) {
                    log('! 未找到 shoebox data。頁面結構可能已更改。');
                    // *** 警告: Fallback 到 HTML 爬蟲 ***
                    log('! Fallback to HTML scraping...');
                    return await getIAPByRegion_Scraping(html, currency); 
                }

                const shoebox = JSON.parse(match[1]);
                const purchases = [];
                
                if (!shoebox.included && !shoebox.data) {
                    log('! Shoebox data 中沒有 "included" 或 "data" 陣列。');
                    return [];
                }
                
                const allData = [
                    ...(Array.isArray(shoebox.data) ? shoebox.data : [shoebox.data]), 
                    ...(shoebox.included || [])
                ].filter(Boolean);


                // 1. 建立 Price Map (ID -> 價格對象)
                const priceMap = new Map();
                allData.forEach(item => {
                    if (item.type === 'in-app-purchase-price') {
                        priceMap.set(item.id, item.attributes);
                    }
                });

                // 2. 建立 IAP Map (ID -> IAP 對象)
                const iapMap = new Map();
                allData.forEach(item => {
                    if (item.type === 'in-app-purchase' || item.type === 'subscription') {
                        iapMap.set(item.id, item);
                    }
                });
                
                log(`  ✓ 找到 ${iapMap.size} 個 IAP/Subscription 項目。`);

                // 3. [新策略] 直接遍歷 iapMap, 不再依賴 'relationships'
                for (const iapItem of iapMap.values()) {
                    try {
                        const name = iapItem.attributes.name;
                        
                        if (iapItem.type === 'in-app-purchase') {
                             if (!iapItem.relationships || !iapItem.relationships.price || !iapItem.relationships.price.data) {
                                log(`  ! IAP ${name} 沒有價格關聯。`);
                                continue;
                            }
                            const priceId = iapItem.relationships.price.data.id;
                            const priceData = priceMap.get(priceId);

                            if (name && priceData) {
                                const priceText = priceData.priceFormatted;
                                const converted = convertToHKD(priceText, currency);
                                purchases.push({ title: name, price: priceText, hkd: converted ? converted.hkd : null });
                                log(`  ✓ [IAP] ${name} - ${priceText}`);
                            }
                        } 
                        else if (iapItem.type === 'subscription') {
                            log(`  ! 找到訂閱 ${name}, 但邏輯尚未實現。`);
                        }

                    } catch (e) {
                        log(`  ! 解析 IAP 項目失敗: ${e.message}`);
                    }
                }

                // 4. 如果 JSON 找不到, 再次嘗試 HTML 爬蟲 (作為最後手段)
                if (purchases.length === 0 && html) { // 確保 html 已被加載
                    log("! JSON 解析未找到 IAP。 嘗試 HTML 爬蟲...");
                    return await getIAPByRegion_Scraping(html, currency);
                }
                
                if (purchases.length > 0) {
                    iapCache.set(cacheKey, purchases);
                    setTimeout(() => iapCache.delete(cacheKey), 24 * 60 * 60 * 1000);
                }

                log(`✓ ${countryCode.toUpperCase()}: ${purchases.length}`);
                return purchases;

            } catch (e) {
                log(`❌ 爬取 IAP 失敗: ${e.message}`);
                 // 如果 fetch 或 JSON parse 失敗, 嘗試使用 html (如果已抓取)
                if (html) {
                    log("! 發生錯誤, 嘗試 HTML 爬蟲作為最終手段...");
                    return await getIAPByRegion_Scraping(html, currency);
                }
                return null;
            }
        }
        
        async function getIAPByRegion_Scraping(html, currency) {
            log("  [Scraping] 執行 HTML 爬蟲...");
            const purchases = [];
            const seen = new Set();
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const priceEls = doc.querySelectorAll('.list-with-numbers__item__price, .product-header__list__item__price, .app-offer__price, [class*="purchase"] [class*="price"]');
                log(`  [Scraping] 找到 ${priceEls.length} 個價格元素`);

                if (priceEls.length > 0) {
                    priceEls.forEach((priceEl, i) => {
                        const priceText = priceEl.textContent.trim();
                        if (!priceText || priceText.toLowerCase() === 'free' || priceText.toLowerCase() === 'get') return;

                        const parent = priceEl.closest('.list-with-numbers__item, .product-header__list__item, li, .app-offer, [class*="purchase-item"]');
                        if (parent) {
                            let name = null;
                            const nameEl = parent.querySelector('.list-with-numbers__item__title, .product-header__list__item__name, h3, h4, strong, [class*="title"], [class*="name"]');
                            if (nameEl) name = nameEl.textContent.trim();

                            if (!name) {
                                const allText = parent.textContent.replace(priceText, '').trim();
                                const lines = allText.split('\n').map(l => l.trim()).filter(l => l && l.length > 2 && l.length < 100);
                                name = lines[0] || null;
                            }
                            
                            if (name && name.toLowerCase().includes('in-app purchase')) {
                                name = null;
                            }

                            if (name && name.length >= 2 && name.length < 100) {
                                const key = name + '|' + priceText;
                                if (!seen.has(key)) {
                                    const converted = convertToHKD(priceText, currency);
                                    purchases.push({ title: name, price: priceText, hkd: converted ? converted.hkd : null });
                                    seen.add(key);
                                    log(`  [Scraping] ${i+1}. ${name} - ${priceText}`);
                                }
                            } else {
                                log(`  [Scraping] ${i+1}. 找到價格 ${priceText} 但未找到名稱。`);
                            }
                        }
                    });
                }
                return purchases;
            } catch (e) {
                 log(`  [Scraping] 爬蟲失敗: ${e.message}`);
                 return null; // 爬蟲失敗
            }
        }

    </script>
</body>
</html>
